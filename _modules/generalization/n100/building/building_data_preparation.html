<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>generalization.n100.building.building_data_preparation &mdash; Automatisk Generalisering 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Automatisk Generalisering
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/custom_tools.html">custom_tools package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/env_setup.html">env_setup package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/file_manager.html">file_manager package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/generalization.n100.building.html">generalization.n100.building package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/input_data.html">input_data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/modules.html">automatisk-generalisering</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Automatisk Generalisering</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">generalization.n100.building.building_data_preparation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for generalization.n100.building.building_data_preparation</h1><div class="highlight"><pre>
<span></span><span class="c1"># Importing modules</span>
<span class="kn">import</span> <span class="nn">arcpy</span>

<span class="c1"># Importing custom files</span>
<span class="kn">from</span> <span class="nn">custom_tools</span> <span class="kn">import</span> <span class="n">custom_arcpy</span>
<span class="kn">import</span> <span class="nn">config</span>
<span class="kn">from</span> <span class="nn">input_data</span> <span class="kn">import</span> <span class="n">input_n50</span>
<span class="kn">from</span> <span class="nn">input_data</span> <span class="kn">import</span> <span class="n">input_n100</span>
<span class="kn">from</span> <span class="nn">input_data</span> <span class="kn">import</span> <span class="n">input_other</span>

<span class="c1"># Importing file manager</span>
<span class="kn">from</span> <span class="nn">file_manager.n100.file_manager_buildings</span> <span class="kn">import</span> <span class="n">Building_N100</span>

<span class="c1"># Importing environment</span>
<span class="kn">from</span> <span class="nn">env_setup</span> <span class="kn">import</span> <span class="n">environment_setup</span>

<span class="c1"># Environment setup</span>
<span class="n">environment_setup</span><span class="o">.</span><span class="n">general_setup</span><span class="p">()</span>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.building.html#generalization.n100.building.building_data_preparation.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summary:</span>
<span class="sd">        This is the main function of building data preparation, which aims to prepare the data for future building generalization processing.</span>

<span class="sd">    Details:</span>
<span class="sd">        1. `preparation_begrensningskurve`:</span>
<span class="sd">            This function creates a buffer for water features using the &quot;begrensningskurve&quot; feature. It prepares the data for future building placement on the water&#39;s edge.</span>

<span class="sd">        2. `preperation_veg_sti`:</span>
<span class="sd">            This function unsplit a line feature of roads to reduce the number of objects in future processing.</span>

<span class="sd">        3. `adding_matrikkel_as_points`:</span>
<span class="sd">            This function adds building points from the matrikkel dataset for areas that are no longer considered urban after the generalization of &quot;arealdekke.&quot; It also adds the required fields and values for future analysis.</span>

<span class="sd">        4. `selecting_grunnriss_for_generalization`:</span>
<span class="sd">            This function selects building polygons (grunnriss) to be generalized. Smaller polygons and churches or hospitals are excluded, transformed into points, and sent to building point generalization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">preparation_begrensningskurve</span><span class="p">()</span>
    <span class="n">preperation_veg_sti</span><span class="p">()</span>
    <span class="n">adding_matrikkel_as_points</span><span class="p">()</span>
    <span class="n">selecting_grunnriss_for_generalization</span><span class="p">()</span></div>



<span class="c1">###################################### Preparing begrensningskurve (limitation curve) ################################################</span>


<div class="viewcode-block" id="preparation_begrensningskurve">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.building.html#generalization.n100.building.building_data_preparation.preparation_begrensningskurve">[docs]</a>
<span class="k">def</span> <span class="nf">preparation_begrensningskurve</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summary:</span>
<span class="sd">        This function creates a buffer for water features using the &quot;begrensningskurve&quot; feature. It prepares the data for future building placement on the water&#39;s edge.</span>

<span class="sd">    Details:</span>
<span class="sd">        - Using the object types (&#39;ElvBekk&#39;, &#39;Havflate&#39;, &#39;Innsjø&#39;, &#39;InnsjøRegulert&#39;) in the &quot;begrensningskurve&quot; feature in SQL expressions to select water features and in inverse to select land features.</span>
<span class="sd">        - Create a temporary feature of water features from the &quot;begrensningskurve&quot; using the defined SQL expression.</span>
<span class="sd">        - Select land features using an inverted selection using the defined SQL expression.</span>
<span class="sd">        - Identify land features near water features by selecting those that boundary-touch with water features to reduce the amount of processing.</span>
<span class="sd">        - Apply a 15-meter buffer to the identified land features to create buffered land features, this is the distance objects is allowed to be overlapping water features in the final output.</span>
<span class="sd">        - Apply a 45-meter buffer to the selected water features to create buffered water features, this is to make sure features are not going past the water barrier and is instead pushed towrds land instead of further inside waterfeatures.</span>
<span class="sd">        - Erase buffered water features from the buffered land features to create a final set of waterfeature buffer which is used throughout this generalization of buildings.</span>

<span class="sd">    Note:</span>
<span class="sd">        - Additional logic may be required for rivers separately in future development as narrow polygons gets completly removed due to the land buffer being to large for the rivers. In processes actually needing barriers this will allow objects to cross narrow rivers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Defining the SQL selection expression for water features for begrensningskurve</span>
    <span class="n">sql_expr_begrensningskurve_waterfeatures</span> <span class="o">=</span> <span class="s2">&quot;OBJTYPE = &#39;ElvBekkKant&#39; Or OBJTYPE = &#39;Innsjøkant&#39; Or OBJTYPE = &#39;InnsjøkantRegulert&#39; Or OBJTYPE = &#39;Kystkontur&#39;&quot;</span>

    <span class="c1"># Creating a temporary feature of water features from begrensningskurve</span>
    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_permanent_feature</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">input_n100</span><span class="o">.</span><span class="n">BegrensningsKurve</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="n">sql_expr_begrensningskurve_waterfeatures</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__selected_waterfeatures_from_begrensningskurve__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_permanent_feature</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">input_n100</span><span class="o">.</span><span class="n">ArealdekkeFlate</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;OBJTYPE NOT IN (&#39;ElvBekk&#39;, &#39;Havflate&#39;, &#39;Innsjø&#39;, &#39;InnsjøRegulert&#39;)&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__selected_land_features_area__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_location_and_make_permanent_feature</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__selected_land_features_area__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">OverlapType</span><span class="o">.</span><span class="n">BOUNDARY_TOUCHES</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__selected_waterfeatures_from_begrensningskurve__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__land_features_near_water__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">PairwiseBuffer</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__land_features_near_water__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__land_features_buffer__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">buffer_distance_or_field</span><span class="o">=</span><span class="s2">&quot;15 Meters&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Buffered land features created&quot;</span><span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">PairwiseBuffer</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__selected_waterfeatures_from_begrensningskurve__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_waterfeatures_buffer__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">buffer_distance_or_field</span><span class="o">=</span><span class="s2">&quot;45 Meters&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Buffered water features created&quot;</span><span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">PairwiseErase</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_waterfeatures_buffer__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">erase_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__selected_land_features_area__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_buffer_erase_1__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Erased 1 completed </span><span class="si">{</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_buffer_erase_1__n100</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> created&quot;</span>
    <span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">PairwiseErase</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_buffer_erase_1__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">erase_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__land_features_buffer__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_buffer_erase_2__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Erased 2 completed </span><span class="si">{</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_buffer_erase_2__n100</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> created&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Need to apply better logic for rivers separatly at a later point&quot;</span><span class="p">)</span>
    <span class="c1"># Needs to use a different logic for narrow rivers, and instead use the centerline and a small buffer around it which is added to the feature class</span>

    <span class="c1"># Adding hierarchy and invisibility fields to the preparation_begrensningskurve__begrensningskurve_buffer_waterfeatures__n100 and setting them to 0</span>
    <span class="c1"># Define field information</span>
    <span class="n">fields_to_add</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;hierarchy&quot;</span><span class="p">,</span> <span class="s2">&quot;LONG&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;invisibility&quot;</span><span class="p">,</span> <span class="s2">&quot;LONG&quot;</span><span class="p">]]</span>
    <span class="n">fields_to_calculate</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;hierarchy&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;invisibility&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]]</span>

    <span class="c1"># Add fields</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">AddFields</span><span class="p">(</span>
        <span class="n">in_table</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_buffer_erase_2__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">field_description</span><span class="o">=</span><span class="n">fields_to_add</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Calculate fields</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">CalculateFields</span><span class="p">(</span>
        <span class="n">in_table</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preparation_begrensningskurve__begrensningskurve_buffer_erase_2__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">expression_type</span><span class="o">=</span><span class="s2">&quot;PYTHON3&quot;</span><span class="p">,</span>
        <span class="n">fields</span><span class="o">=</span><span class="n">fields_to_calculate</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="c1">###################################### Preparing roads ################################################</span>


<div class="viewcode-block" id="preperation_veg_sti">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.building.html#generalization.n100.building.building_data_preparation.preperation_veg_sti">[docs]</a>
<span class="k">def</span> <span class="nf">preperation_veg_sti</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summary:</span>
<span class="sd">        This function unsplit a line feature of roads to reduce the number of objects in future processing.</span>

<span class="sd">    Details:</span>
<span class="sd">        - It takes the input line feature `input_n100.VegSti` and removes any geometric splits.</span>
<span class="sd">        - The feature is dissolved based on the fields &quot;subtypekode,&quot; &quot;motorvegtype,&quot; and &quot;UTTEGNING&quot; to merge segments with the same values in these fields.</span>
<span class="sd">    Note:</span>
<span class="sd">        - In the future when the inputs makes spatial selections of the features used for context for processing like roads this step is redundant and will instead increase processing time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">UnsplitLine_management</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">input_n100</span><span class="o">.</span><span class="n">VegSti</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">preperation_veg_sti__unsplit_veg_sti__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">dissolve_field</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subtypekode&quot;</span><span class="p">,</span> <span class="s2">&quot;motorvegtype&quot;</span><span class="p">,</span> <span class="s2">&quot;UTTEGNING&quot;</span><span class="p">],</span>
    <span class="p">)</span></div>



<span class="c1">###################################### Adding matrikkel-points (cadastre) for areas which are no longer urban ################################################</span>


<div class="viewcode-block" id="adding_matrikkel_as_points">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.building.html#generalization.n100.building.building_data_preparation.adding_matrikkel_as_points">[docs]</a>
<span class="k">def</span> <span class="nf">adding_matrikkel_as_points</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summary:</span>
<span class="sd">        This function adds building points from the matrikkel dataset for areas that are no longer considered urban after the generalization of &#39;ArealdekkeFlate&#39;. It also adds the required fields and values for future analysis.</span>

<span class="sd">    Details:</span>
<span class="sd">        - Define an SQL expression to select urban areas (&#39;Tettbebyggelse&#39;, &#39;Industriområde&#39;, &#39;BymessigBebyggelse&#39;) in the &#39;ArealdekkeFlate&#39; dataset.</span>
<span class="sd">        - Select urban areas from &#39;ArealdekkeFlate&#39; in both n100 and n50 datasets using the defined SQL expression.</span>
<span class="sd">        - Create a buffer of the selected urban areas from n100 to take into consideration that points should not be too close to urban areas.</span>
<span class="sd">        - Remove areas from n50 urban areas that intersect with the buffer of n100 urban areas, resulting in areas in n100 that are no longer considered urban.</span>
<span class="sd">        - Select matrikkel bygningspunkter based on the new urban selection layer.</span>
<span class="sd">        - Transfer the NBR (building type) value to the matrikkel_bygningspunkt dataset by adding a new field &quot;BYGGTYP_NBR&quot; of type LONG and calculating its values from the &quot;bygningstype&quot; field.</span>
<span class="sd">    Note:</span>
<span class="sd">        - Should consider removing the logic of adding a buffer to the urban areas to prevent points to close to urban areas and instead using urban areas as a barrier feature in future processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Defining sql expression to select urban areas</span>
    <span class="n">urban_areas_sql_expr</span> <span class="o">=</span> <span class="s2">&quot;OBJTYPE = &#39;Tettbebyggelse&#39; Or OBJTYPE = &#39;Industriområde&#39; Or OBJTYPE = &#39;BymessigBebyggelse&#39;&quot;</span>

    <span class="c1"># Selecting urban areas from n100 using sql expression</span>
    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_feature_layer</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">input_n100</span><span class="o">.</span><span class="n">ArealdekkeFlate</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="n">urban_areas_sql_expr</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__urban_area_selection_n100__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Selecting urban areas from n50 using sql expression</span>
    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_feature_layer</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">input_n50</span><span class="o">.</span><span class="n">ArealdekkeFlate</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="n">urban_areas_sql_expr</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__urban_area_selection_n50__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Creating a buffer of the urban selection of n100 to take into account symbology</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">PairwiseBuffer_analysis</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__urban_area_selection_n100__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__urban_area_selection_n100_buffer__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">buffer_distance_or_field</span><span class="o">=</span><span class="s2">&quot;50 Meters&quot;</span><span class="p">,</span>
        <span class="n">dissolve_option</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
        <span class="n">dissolve_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;PLANAR&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Removing areas from n50 urban areas from the buffer of n100 urban areas resulting in areas in n100 which no longer are urban</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">PairwiseErase_analysis</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__urban_area_selection_n50__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">erase_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__urban_area_selection_n100_buffer__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__no_longer_urban_areas__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Selecting matrikkel bygningspunkter based on this new urban selection layer</span>
    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_location_and_make_permanent_feature</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">input_other</span><span class="o">.</span><span class="n">matrikkel_bygningspunkt</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">OverlapType</span><span class="o">.</span><span class="n">INTERSECT</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__no_longer_urban_areas__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__matrikkel_bygningspunkt__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Adding transferring the NBR value to the matrikkel_bygningspunkt</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">AddField_management</span><span class="p">(</span>
        <span class="n">in_table</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__matrikkel_bygningspunkt__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;BYGGTYP_NBR&quot;</span><span class="p">,</span>
        <span class="n">field_type</span><span class="o">=</span><span class="s2">&quot;LONG&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">CalculateField_management</span><span class="p">(</span>
        <span class="n">in_table</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__matrikkel_bygningspunkt__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">field</span><span class="o">=</span><span class="s2">&quot;BYGGTYP_NBR&quot;</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;!bygningstype!&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="c1">###################################### Transforms hospitals and churches polygons to points ################################################</span>


<div class="viewcode-block" id="selecting_grunnriss_for_generalization">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.building.html#generalization.n100.building.building_data_preparation.selecting_grunnriss_for_generalization">[docs]</a>
<span class="k">def</span> <span class="nf">selecting_grunnriss_for_generalization</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summary:</span>
<span class="sd">        This function selects building polygons (grunnriss) to be generalized. Smaller polygons and churches or hospitals are excluded, transformed into points, and sent to building point generalization.</span>

<span class="sd">    Details:</span>
<span class="sd">        - Reclassify hospitals and churches from polygons to &#39;NBR 729&#39; (other buildings).</span>
<span class="sd">        - Select grunnriss that are not churches or hospitals using inverted selection.</span>
<span class="sd">        - Select grunnriss that are large enough based on a minimum polygon size of 1500 square meters.</span>
<span class="sd">        - Transform small grunnriss features into points by calculating centroids.</span>
<span class="sd">        - Select grunnriss features that represent churches and hospitals.</span>
<span class="sd">        - Transform selected church and hospital grunnriss features into points by calculating centroids.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        - Minimum Polygon Size: The minimum size of polygons, in square meters. It currently at **&#39;1500 Meters&#39;**.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Reclassify the sykehus from grunnriss to another NBR value</span>
    <span class="n">code_block_hospital</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;def hospital_nbr(nbr):</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    mapping = {970: 729, 719: 729}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;    return mapping.get(nbr, nbr)&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Reclassify the sykehus from grunnriss to another NBR value</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">CalculateField_management</span><span class="p">(</span>
        <span class="n">in_table</span><span class="o">=</span><span class="n">input_n50</span><span class="o">.</span><span class="n">Grunnriss</span><span class="p">,</span>
        <span class="n">field</span><span class="o">=</span><span class="s2">&quot;BYGGTYP_NBR&quot;</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;hospital_nbr(!BYGGTYP_NBR!)&quot;</span><span class="p">,</span>
        <span class="n">expression_type</span><span class="o">=</span><span class="s2">&quot;PYTHON3&quot;</span><span class="p">,</span>
        <span class="n">code_block</span><span class="o">=</span><span class="n">code_block_hospital</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Expression to be able to select churchs and hospitals</span>
    <span class="n">sql_nrb_code_sykehus</span> <span class="o">=</span> <span class="s2">&quot;BYGGTYP_NBR IN (970, 719)&quot;</span>
    <span class="n">sql_nbr_code_kirke</span> <span class="o">=</span> <span class="s2">&quot;BYGGTYP_NBR IN (671)&quot;</span>

    <span class="c1"># Selecting grunnriss which are not churches or hospitals using inverted selection</span>
    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_permanent_feature</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">input_n50</span><span class="o">.</span><span class="n">Grunnriss</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="n">sql_nbr_code_kirke</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__selected_grunnriss_not_church__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">selection_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">SelectionType</span><span class="o">.</span><span class="n">NEW_SELECTION</span><span class="p">,</span>
        <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Selecting grunnriss which are large enough</span>
    <span class="n">grunnriss_minimum_size</span> <span class="o">=</span> <span class="mi">1500</span>
    <span class="n">sql_expression_too_small_grunnriss</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Shape_Area &lt; </span><span class="si">{</span><span class="n">grunnriss_minimum_size</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">sql_expression_correct_size_grunnriss</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Shape_Area &gt;= </span><span class="si">{</span><span class="n">grunnriss_minimum_size</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_permanent_feature</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__selected_grunnriss_not_church__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="n">sql_expression_correct_size_grunnriss</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__large_enough_grunnriss__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_feature_layer</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__selected_grunnriss_not_church__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="n">sql_expression_too_small_grunnriss</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__too_small_grunnriss__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">selection_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">SelectionType</span><span class="o">.</span><span class="n">NEW_SELECTION</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Transforming small grunnriss features into points</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">FeatureToPoint_management</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__too_small_grunnriss__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__points_created_from_small_grunnriss__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">point_location</span><span class="o">=</span><span class="s2">&quot;CENTROID&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Selecting grunnriss features not inverted based on sql expression above to select churches and hospitals</span>
    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_feature_layer</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">input_n50</span><span class="o">.</span><span class="n">Grunnriss</span><span class="p">,</span>
        <span class="n">expression</span><span class="o">=</span><span class="n">sql_nbr_code_kirke</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__grunnriss_kirke__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Transforming selected churches and hospitals into points</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">FeatureToPoint_management</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__grunnriss_kirke__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">out_feature_class</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">selecting_grunnriss_for_generalization__kirke_points_created_from_grunnriss__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">point_location</span><span class="o">=</span><span class="s2">&quot;CENTROID&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="c1">###################################### FILL ################################################</span>


<div class="viewcode-block" id="removing_overlapping_byggningspunkt_and_grunnriss_matrikkel">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.building.html#generalization.n100.building.building_data_preparation.removing_overlapping_byggningspunkt_and_grunnriss_matrikkel">[docs]</a>
<span class="k">def</span> <span class="nf">removing_overlapping_byggningspunkt_and_grunnriss_matrikkel</span><span class="p">():</span>
    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_location_and_make_permanent_feature</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">input_n50</span><span class="o">.</span><span class="n">BygningsPunkt</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">OverlapType</span><span class="o">.</span><span class="n">WITHIN</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">input_n50</span><span class="o">.</span><span class="n">Grunnriss</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="s2">&quot;NEEDS UPDATE&quot;</span><span class="p">,</span>
        <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_location_and_make_permanent_feature</span><span class="p">(</span>
        <span class="n">input_layer</span><span class="o">=</span><span class="n">Building_N100</span><span class="o">.</span><span class="n">adding_matrikkel_as_points__matrikkel_bygningspunkt__n100</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">OverlapType</span><span class="o">.</span><span class="n">WITHIN</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">input_n50</span><span class="o">.</span><span class="n">Grunnriss</span><span class="p">,</span>
        <span class="n">output_name</span><span class="o">=</span><span class="s2">&quot;NEEDS UPDATE&quot;</span><span class="p">,</span>
        <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kartverket.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>