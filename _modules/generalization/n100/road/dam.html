

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>generalization.n100.road.dam &mdash; Automatisk Generalisering 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Automatisk Generalisering
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/custom_tools.html">custom_tools package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/env_setup.html">env_setup package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/file_manager.html">file_manager package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/generalization.n100.building.html">generalization.n100.building package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/input_data.html">input_data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../generated_docs/modules.html">automatisk-generalisering</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Automatisk Generalisering</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">generalization.n100.road.dam</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for generalization.n100.road.dam</h1><div class="highlight"><pre>
<span></span><span class="c1"># Importing packages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">arcpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">arcpy</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">overwriteOutput</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Importing custom input files modules</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">input_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">input_n100</span>

<span class="c1"># Importing custom modules</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">file_manager.n100.file_manager_roads</span><span class="w"> </span><span class="kn">import</span> <span class="n">Road_N100</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">env_setup</span><span class="w"> </span><span class="kn">import</span> <span class="n">environment_setup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">custom_tools.decorators.timing_decorator</span><span class="w"> </span><span class="kn">import</span> <span class="n">timing_decorator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">custom_tools.general_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">custom_arcpy</span>

<span class="n">data_files</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Stores all the relevant file paths to the geodata used in this Python file</span>
    <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">data_preparation___resolve_road_conflicts___n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__cleaned_roads__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;roads_input&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__relevant_roads__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;dam_input&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__relevant_dam__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;water_input&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__relevant_water__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;dam_35m&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__dam_buffer_35m__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;roads_inside&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__roads_inside_with_data__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;roads_outside&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__roads_outside__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;water_clipped&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__water_clipped__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;water_center&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__water_center__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;buffer_water&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__buffer_water__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;water_singleparts&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__water_singleparts__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;dam_buffer_sti&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__dam_buffer_sti__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;roads_clipped_sti&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__roads_clipped_sti__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;roads_moved&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__roads_moved__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;roads_shifted&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__roads_shifted__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;dam_150m&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__dam_buffer_150m__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;dam_60m_flat&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__dam_buffer_60m_flat__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;dam_5m&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__dam_buffer_5m_flat__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;dam_60m&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__dam_buffer_60m__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;water_55m&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__water_buffer_55m__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;buffer_line&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__dam_buffer_60m_line__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;intermediate&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__roads_intermediate__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;paths_in_dam&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__paths_in_dam__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="s2">&quot;paths_in_dam_valid&quot;</span><span class="p">:</span> <span class="n">Road_N100</span><span class="o">.</span><span class="n">dam__paths_in_dam_valid__n100_road</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">files_to_delete</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Stores all the keys from &#39;data_files&#39; that should be deleted in the end</span>
    <span class="s2">&quot;water_input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dam_35m&quot;</span><span class="p">,</span>
    <span class="s2">&quot;roads_inside&quot;</span><span class="p">,</span>
    <span class="s2">&quot;roads_outside&quot;</span><span class="p">,</span>
    <span class="s2">&quot;water_clipped&quot;</span><span class="p">,</span>
    <span class="s2">&quot;water_center&quot;</span><span class="p">,</span>
    <span class="s2">&quot;buffer_water&quot;</span><span class="p">,</span>
    <span class="s2">&quot;water_singleparts&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dam_buffer_sti&quot;</span><span class="p">,</span>
    <span class="s2">&quot;roads_clipped_sti&quot;</span><span class="p">,</span>
    <span class="s2">&quot;roads_moved&quot;</span><span class="p">,</span>
    <span class="s2">&quot;roads_shifted&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dam_150m&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dam_60m_flat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dam_5m&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dam_60m&quot;</span><span class="p">,</span>
    <span class="s2">&quot;water_55m&quot;</span><span class="p">,</span>
    <span class="s2">&quot;intermediate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;paths_in_dam&quot;</span><span class="p">,</span>
    <span class="s2">&quot;paths_in_dam_valid&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.main">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hva den gjør:</span>
<span class="sd">       Denne tar veier som går innen 60 meter av demninger og flytter de ut til 60 meter unna demningen.</span>

<span class="sd">    Hvorfor:</span>
<span class="sd">        For at symbologien skal være synlig i N100 kartet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Setup</span>
    <span class="n">environment_setup</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

    <span class="c1"># Data preparation</span>
    <span class="n">fetch_data</span><span class="p">()</span>

    <span class="c1"># Data preparation</span>
    <span class="n">create_buffer</span><span class="p">()</span>
    <span class="n">create_buffer_line</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">data_check</span><span class="p">():</span>
        <span class="c1"># Move dam away from lakes</span>
        <span class="n">clip_and_erase_pre</span><span class="p">()</span>
        <span class="n">snap_merge_before_moving</span><span class="p">()</span>
        <span class="n">edit_geom_pre</span><span class="p">()</span>
        <span class="n">snap_and_merge_pre</span><span class="p">()</span>

        <span class="c1"># Snap roads to buffer</span>
        <span class="n">roads</span> <span class="o">=</span> <span class="n">connect_roads_with_buffers</span><span class="p">()</span>
        <span class="n">roads</span> <span class="o">=</span> <span class="n">merge_instances</span><span class="p">(</span><span class="n">roads</span><span class="p">)</span>
        <span class="n">snap_roads</span><span class="p">(</span><span class="n">roads</span><span class="p">)</span>
        <span class="n">remove_sharp_angles</span><span class="p">(</span><span class="n">roads</span><span class="p">)</span>

        <span class="c1"># Deletes all the intermediate files created during the process</span>
        <span class="n">delete_intermediate_files</span><span class="p">()</span></div>



<span class="c1">##################</span>
<span class="c1"># Help functions</span>
<span class="c1">##################</span>


<div class="viewcode-block" id="data_check">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.data_check">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">data_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sjekker om det er noen veier innen 60 meter av demninger</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_60m_flat&quot;</span><span class="p">]</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">MakeFeatureLayer_management</span><span class="p">(</span><span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_input&quot;</span><span class="p">],</span> <span class="s2">&quot;roads_lyr&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">SelectLayerByLocation_management</span><span class="p">(</span>
        <span class="n">in_layer</span><span class="o">=</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;INTERSECT&quot;</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">buffer_fc</span><span class="p">,</span>
        <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arcpy</span><span class="o">.</span><span class="n">GetCount_management</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No roads close to dam...&quot;</span><span class="p">)</span>
        <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_permanent_feature</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="o">=</span><span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span>
            <span class="n">output_name</span><span class="o">=</span><span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span>
            <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="build_backup">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.build_backup">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_backup</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bygger en backup dict av en layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Discover all non-OID, non-Geometry fields in backup</span>
    <span class="n">all_fields</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">ListFields</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">attr_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_fields</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;OID&quot;</span><span class="p">,</span> <span class="s2">&quot;Geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;Blob&quot;</span><span class="p">,</span> <span class="s2">&quot;Raster&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># 2. Build your cursor field lists</span>
    <span class="c1">#    - search_fields: includes OID@ so you can key the dict</span>
    <span class="c1">#    - insert_fields: includes SHAPE@ plus all attribute fields</span>
    <span class="n">insert_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SHAPE@&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attr_fields</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">insert_fields</span>

    <span class="c1"># 3. Read originals into an in-memory dict</span>
    <span class="n">backup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">search_fields</span><span class="p">)</span> <span class="k">as</span> <span class="n">s_cur</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">s_cur</span><span class="p">:</span>
            <span class="n">oid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">geom_and_attrs</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">backup</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="o">=</span> <span class="n">geom_and_attrs</span>

    <span class="k">return</span> <span class="n">backup</span></div>



<div class="viewcode-block" id="restore_deleted_lines">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.restore_deleted_lines">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">restore_deleted_lines</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">backup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gjennopretter features som har blitt slettet under snapping</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deleted_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 1. Discover all non-OID, non-Geometry fields in backup</span>
    <span class="n">all_fields</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">ListFields</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">attr_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_fields</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;OID&quot;</span><span class="p">,</span> <span class="s2">&quot;Geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;Blob&quot;</span><span class="p">,</span> <span class="s2">&quot;Raster&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># 2. Build your cursor field lists</span>
    <span class="c1">#    - search_fields: includes OID@ so you can key the dict</span>
    <span class="c1">#    - insert_fields: includes SHAPE@ plus all attribute fields</span>
    <span class="n">insert_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SHAPE@&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attr_fields</span>

    <span class="c1"># 3. Delete features with None geometry after snapping</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">deleted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">deleteRow</span><span class="p">()</span>

    <span class="c1"># 4. Insert missing features back into your target feature class</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">InsertCursor</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">insert_fields</span><span class="p">)</span> <span class="k">as</span> <span class="n">i_cur</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">deleted_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">backup</span><span class="p">:</span>
                <span class="n">i_cur</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">backup</span><span class="p">[</span><span class="n">oid</span><span class="p">])</span></div>



<div class="viewcode-block" id="merge_all_lines2">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.merge_all_lines2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">merge_all_lines2</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges all lines in a feature class that share endpoints and have the same objtype and vegkategori.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Determine non‐OID/Geometry fields and their positions</span>
    <span class="n">all_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">ListFields</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;OID&quot;</span><span class="p">,</span> <span class="s2">&quot;Geometry&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Ensure the required fields exist</span>
    <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;objtype&quot;</span><span class="p">,</span> <span class="s2">&quot;vegkategori&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">req</span><span class="si">}</span><span class="s2">&#39; is missing in </span><span class="si">{</span><span class="n">fc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">idx_objtype</span> <span class="o">=</span> <span class="n">all_fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;objtype&quot;</span><span class="p">)</span>
    <span class="n">idx_vegkategori</span> <span class="o">=</span> <span class="n">all_fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;vegkategori&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Read all lines into memory</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_fields</span><span class="p">)</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="o">*</span><span class="n">attrs</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;oid&quot;</span><span class="p">:</span> <span class="n">oid</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="n">geom</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="n">attrs</span><span class="p">})</span>

    <span class="c1"># 3. Build adjacency graph—only if objtype &amp; medium match *and* endpoints are within tolerance</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ln1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">ot1</span> <span class="o">=</span> <span class="n">ln1</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">][</span><span class="n">idx_objtype</span><span class="p">]</span>
        <span class="n">md1</span> <span class="o">=</span> <span class="n">ln1</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">][</span><span class="n">idx_vegkategori</span><span class="p">]</span>
        <span class="n">eps1</span> <span class="o">=</span> <span class="n">get_endpoints_cords</span><span class="p">(</span><span class="n">ln1</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ln2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Skip if attributes don’t match</span>
            <span class="n">ot2</span> <span class="o">=</span> <span class="n">ln2</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">][</span><span class="n">idx_objtype</span><span class="p">]</span>
            <span class="n">md2</span> <span class="o">=</span> <span class="n">ln2</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">][</span><span class="n">idx_vegkategori</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ot1</span><span class="p">,</span> <span class="n">md1</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ot2</span><span class="p">,</span> <span class="n">md2</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Check endpoint proximity</span>
            <span class="n">eps2</span> <span class="o">=</span> <span class="n">get_endpoints_cords</span><span class="p">(</span><span class="n">ln2</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">within_tol</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span> <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">eps1</span> <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">eps2</span><span class="p">):</span>
                <span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">adj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># 4. Find connected components (clusters)</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">stack</span><span class="p">,</span> <span class="n">comp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">curr</span><span class="p">]</span> <span class="o">-</span> <span class="n">visited</span><span class="p">)</span>
        <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

    <span class="c1"># 5. Union geometries per cluster and carry forward attributes</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">]</span>
        <span class="c1"># dissolve shapes</span>
        <span class="n">cumul</span> <span class="o">=</span> <span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">cumul</span> <span class="o">=</span> <span class="n">cumul</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># re‐use attrs from the first member of the cluster</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cumul</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">comp</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;attrs&quot;</span><span class="p">]))</span>

    <span class="c1"># 6. Overwrite the feature class with merged results</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">DeleteRows_management</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>
    <span class="n">out_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SHAPE@&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_fields</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">InsertCursor</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">out_fields</span><span class="p">)</span> <span class="k">as</span> <span class="n">icur</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
            <span class="n">icur</span><span class="o">.</span><span class="n">insertRow</span><span class="p">([</span><span class="n">geom</span><span class="p">]</span> <span class="o">+</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merged </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="si">}</span><span class="s2"> lines into </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span><span class="si">}</span><span class="s2"> features.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="within_tol">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.within_tol">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">within_tol</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Euclidean distance test.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">pt1</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">pt2</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">pt1</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">pt2</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span></div>



<div class="viewcode-block" id="get_endpoints_cords">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.get_endpoints_cords">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_endpoints_cords</span><span class="p">(</span><span class="n">polyline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a list of Point objects for the start/end of every part.&quot;&quot;&quot;</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">polyline</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coords</span><span class="p">:</span>
            <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pts</span></div>



<div class="viewcode-block" id="snap_by_objtype">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.snap_by_objtype">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">snap_by_objtype</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Snapper veier med samme objtype</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get all unique objtypes</span>
    <span class="n">objtypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;objtype&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">objtypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objtypes</span><span class="p">:</span>
        <span class="c1"># Make a feature layer for this objtype</span>
        <span class="n">layer_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;roads_moved_</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;objtype = &#39;</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># Snap only within this objtype group</span>
        <span class="n">snap_env</span> <span class="o">=</span> <span class="p">[[</span><span class="n">layer_name</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="s2">&quot;40 Meters&quot;</span><span class="p">]]</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">Snap_edit</span><span class="p">(</span><span class="n">layer_name</span><span class="p">,</span> <span class="n">snap_env</span><span class="p">)</span>

        <span class="n">arcpy</span><span class="o">.</span><span class="n">Delete_management</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span></div>



<div class="viewcode-block" id="move_line_away">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.move_line_away">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">move_line_away</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">near_x</span><span class="p">,</span> <span class="n">near_y</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move a polyline geometry away from a point (near_x, near_y) by a specified distance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sr</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">spatialReference</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">centroid</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">centroid</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">near_x</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">centroid</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">near_y</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># No movement if centroid is at water center</span>
        <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">length</span>
        <span class="n">shift_x</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">shift_y</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">scale</span>

    <span class="n">new_parts</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Array</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">geom</span><span class="p">:</span>
        <span class="n">part_arr</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Array</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">X</span> <span class="o">+</span> <span class="n">shift_x</span>
            <span class="n">new_y</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Y</span> <span class="o">+</span> <span class="n">shift_y</span>
            <span class="n">part_arr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arcpy</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">))</span>
        <span class="n">new_parts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">part_arr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Polyline</span><span class="p">(</span><span class="n">new_parts</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_endpoints">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.get_endpoints">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_endpoints</span><span class="p">(</span>
    <span class="n">polyline</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">arcpy</span><span class="o">.</span><span class="n">PointGeometry</span><span class="p">,</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">PointGeometry</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the start and end points of a polyline</span>

<span class="sd">    Args:</span>
<span class="sd">        polyline (arcpy.Geometry): The geometry (line) to be analysed</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple(arcpy.PointGeometry): tuple with start and end points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">PointGeometry</span><span class="p">(</span><span class="n">polyline</span><span class="o">.</span><span class="n">firstPoint</span><span class="p">,</span> <span class="n">polyline</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">),</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">PointGeometry</span><span class="p">(</span><span class="n">polyline</span><span class="o">.</span><span class="n">lastPoint</span><span class="p">,</span> <span class="n">polyline</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">),</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="add_road">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.add_road">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_road</span><span class="p">(</span><span class="n">road_lyr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roads</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span> <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds roads selected in road_lyr to the dictionary roads</span>
<span class="sd">    if they are connected (closer than tolerance).</span>
<span class="sd">    These are the roads relevant for the movement analysis.</span>

<span class="sd">    Args:</span>
<span class="sd">        road_lyr (str): String to the feature layer</span>
<span class="sd">        roads (dict[list]): Dictionary with relevant road objects</span>
<span class="sd">        tolerance (float): Float number showing tolerance of connection to be added, default 2.0</span>

<span class="sd">    Returns:</span>
<span class="sd">        roads (dict[list]): Updated dictionary with relevant road objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Build endpoint lookup for existing roads in the road dictionary</span>
    <span class="n">endpoint_lookup</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">roads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_endpoints</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        <span class="c1"># Uses rounded coordinates for fast lookup and more similarity</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">endpoint_lookup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>

    <span class="c1"># Add new roads if they have a endpoint closer than tolerance to an existing road</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span>
        <span class="n">road_lyr</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">,</span> <span class="s2">&quot;objtype&quot;</span><span class="p">,</span> <span class="s2">&quot;vegkategori&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">roads</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_endpoints</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
            <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="c1"># Check if the endpoints are close to another geometry</span>
                <span class="k">for</span> <span class="n">other_key</span> <span class="ow">in</span> <span class="n">endpoint_lookup</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">other_oid</span> <span class="ow">in</span> <span class="n">endpoint_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">other_key</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="n">other_geom</span> <span class="o">=</span> <span class="n">roads</span><span class="p">[</span><span class="n">other_oid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">distance</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">other_geom</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                            <span class="n">roads</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">geom</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">category</span><span class="p">]</span>
                            <span class="c1"># Add endpoints of this road to lookup for future checks</span>
                            <span class="k">for</span> <span class="n">new_pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]:</span>
                                <span class="n">new_key</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="nb">round</span><span class="p">(</span><span class="n">new_pt</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                    <span class="nb">round</span><span class="p">(</span><span class="n">new_pt</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                <span class="p">)</span>
                                <span class="n">endpoint_lookup</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>
                            <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">added</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">added</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="k">return</span> <span class="n">roads</span></div>



<div class="viewcode-block" id="find_merge_candidate">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.find_merge_candidate">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_merge_candidate</span><span class="p">(</span>
    <span class="n">short_geom</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span>
    <span class="n">all_roads</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span>
    <span class="n">buffer</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span>
    <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds a road geometry that shares a common end point</span>

<span class="sd">    Args:</span>
<span class="sd">        short_geom (arcpy.Geometry): The geometry that should be checked</span>
<span class="sd">        all_roads (list[list]): oid and geom of relevant roads to connect to</span>
<span class="sd">        buffer (arcpy.Geometry): The geometry of the relevant buffer</span>
<span class="sd">        tolerance (float): Float number showing tolerance of connection to be added, default 2.0</span>

<span class="sd">    Returns:</span>
<span class="sd">        str | None: The oid of the matched road oid if one, else None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_endpoints</span><span class="p">(</span><span class="n">short_geom</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">all_roads</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">get_endpoints</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        <span class="n">endpoint_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">s</span><span class="p">),</span> <span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">e</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">endpoint_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p1</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">buffer</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">buffer</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">p2</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">oid</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="reverse_geometry">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.reverse_geometry">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reverse_geometry</span><span class="p">(</span><span class="n">polyline</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Polyline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Createas a reversed copy of the input geometry (line).</span>
<span class="sd">    Only singlepart.</span>

<span class="sd">    Args:</span>
<span class="sd">        polyline (arcpy.Geometry): The line to be reversed</span>

<span class="sd">    Returns:</span>
<span class="sd">        arcpy.Polyline: The reversed line</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reversed_parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">polyline</span><span class="p">:</span>
        <span class="n">reversed_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arcpy</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">part</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Polyline</span><span class="p">(</span><span class="n">arcpy</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">reversed_parts</span><span class="p">),</span> <span class="n">polyline</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">)</span></div>



<div class="viewcode-block" id="merge_lines">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.merge_lines">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">merge_lines</span><span class="p">(</span>
    <span class="n">line1</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span> <span class="n">line2</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Polyline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges two lines into one common one.</span>
<span class="sd">    Calls itself with reversed geometries if incorrect directions of the input geometries.</span>

<span class="sd">    Args:</span>
<span class="sd">        line1 (arcpy.Geometry): The first line to merge</span>
<span class="sd">        line2 (arcpy.Geometry): The second line to merge</span>
<span class="sd">        tolerance (float): Float number showing tolerance of connection to be merged, default 2.0</span>

<span class="sd">    Returns:</span>
<span class="sd">        arcpy.Polyline | None: A merged polyline containing both the geometries. None if something fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l1_start</span><span class="p">,</span> <span class="n">l1_end</span> <span class="o">=</span> <span class="n">get_endpoints</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
    <span class="n">l2_start</span><span class="p">,</span> <span class="n">l2_end</span> <span class="o">=</span> <span class="n">get_endpoints</span><span class="p">(</span><span class="n">line2</span><span class="p">)</span>

    <span class="c1"># Find the matching endpoints</span>
    <span class="k">if</span> <span class="n">l1_end</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">l2_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
        <span class="c1"># Correct order</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Array</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">line1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">line2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pt</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">line1</span><span class="o">.</span><span class="n">lastPoint</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Polyline</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">line1</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">l1_end</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">l2_end</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
        <span class="c1"># Reverse line2</span>
        <span class="n">line2_rev</span> <span class="o">=</span> <span class="n">reverse_geometry</span><span class="p">(</span><span class="n">line2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merge_lines</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2_rev</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">l1_start</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">l2_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
        <span class="c1"># Reverse line1</span>
        <span class="n">line1_rev</span> <span class="o">=</span> <span class="n">reverse_geometry</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merge_lines</span><span class="p">(</span><span class="n">line1_rev</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">l1_start</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">l2_end</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
        <span class="c1"># Reverse both</span>
        <span class="n">line1_rev</span> <span class="o">=</span> <span class="n">reverse_geometry</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
        <span class="n">line2_rev</span> <span class="o">=</span> <span class="n">reverse_geometry</span><span class="p">(</span><span class="n">line2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">merge_lines</span><span class="p">(</span><span class="n">line1_rev</span><span class="p">,</span> <span class="n">line2_rev</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No match</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="create_single_buffer_line">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.create_single_buffer_line">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_single_buffer_line</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span> <span class="n">water</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a polyline showing the edges of a buffer, excluding areas in water,</span>
<span class="sd">    and saves it to a temporarly &#39;in_memory&#39;-layer.</span>

<span class="sd">    Args:</span>
<span class="sd">        buffer (arcpy.Geometry): The buffer to create the line from</span>
<span class="sd">        water: The feature layer containing the water geometries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;in_memory\dam_line_single&quot;</span>
    <span class="n">final</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;in_memory\dam_line_final&quot;</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">PolygonToLine</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Erase</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">water</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span></div>



<div class="viewcode-block" id="cluster_points">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.cluster_points">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cluster_points</span><span class="p">(</span><span class="n">points</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clusters points that are within the tolerance</span>
<span class="sd">    distance of each other.</span>

<span class="sd">    Args:</span>
<span class="sd">        points (list[tuple]): A list of tuples containing all the points to be clustered</span>
<span class="sd">        tolerance (float): Float number showing tolerance of connection to be clustered, default 2.0</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[list]: A list of list where the internal lists are each cluster with the relevant point information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pt</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tolerance</span> <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">):</span>
                <span class="c1"># The points are close enough to be in the same cluster</span>
                <span class="c1"># With other words: snap them to the same coordinate</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pt</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">pt</span><span class="p">,</span> <span class="n">idx</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">clusters</span></div>



<div class="viewcode-block" id="calculate_angle">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.calculate_angle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_angle</span><span class="p">(</span>
    <span class="n">p1</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span> <span class="n">p2</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span> <span class="n">p3</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the angle in point 2 between point 1 and 3.</span>

<span class="sd">    Args:</span>
<span class="sd">        p1 (arcpy.Geometry): Point 1</span>
<span class="sd">        p2 (arcpy.Geometry): Point 2 (the angle to be calculated is in this point)</span>
<span class="sd">        p3 (arcpy.Geometry): Point 3</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The angle in point 2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Vectors from p2 to p1, and p2 to p3</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p1</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">p2</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">p2</span><span class="o">.</span><span class="n">Y</span><span class="p">])</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p3</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">p2</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">p3</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">p2</span><span class="o">.</span><span class="n">Y</span><span class="p">])</span>

    <span class="c1"># Lenghts of the vectors</span>
    <span class="n">len1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">len2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">len1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">len2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">360</span>  <span class="c1"># Undefined angle, treated as straight line</span>

    <span class="c1"># Calculate scalar product</span>
    <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>

    <span class="c1"># Calculates angle in degrees</span>
    <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">dot</span> <span class="o">/</span> <span class="p">(</span><span class="n">len1</span> <span class="o">*</span> <span class="n">len2</span><span class="p">)</span>
    <span class="n">cos_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_angle</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span></div>



<div class="viewcode-block" id="not_road_intersection">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.not_road_intersection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">not_road_intersection</span><span class="p">(</span><span class="n">point</span><span class="p">:</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">,</span> <span class="n">road_oid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">roads</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if the point is connected to a road intersection or not.</span>

<span class="sd">    Args:</span>
<span class="sd">        point (arcpy.Geometry): The point geometry to consider</span>
<span class="sd">        road_oid (str): The oid of the road containing this point</span>
<span class="sd">        roads (str): Feature layer containing all the relevant roads</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: False if the point is in a road intersection, otherwise True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point_geom</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">PointGeometry</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
    <span class="n">tolerance</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">roads</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">oid</span> <span class="o">==</span> <span class="n">road_oid</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">shape</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">point_geom</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<span class="c1">##################</span>
<span class="c1"># Main functions</span>
<span class="c1">##################</span>


<div class="viewcode-block" id="fetch_data">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.fetch_data">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fetching data...&quot;</span><span class="p">)</span>

    <span class="nb">input</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_input&quot;</span><span class="p">]],</span>  <span class="c1"># Roads</span>
        <span class="p">[</span><span class="n">input_n100</span><span class="o">.</span><span class="n">AnleggsLinje</span><span class="p">,</span> <span class="s2">&quot;objtype = &#39;Dam&#39;&quot;</span><span class="p">,</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_input&quot;</span><span class="p">]],</span>  <span class="c1"># Dam</span>
        <span class="p">[</span>
            <span class="n">input_n100</span><span class="o">.</span><span class="n">ArealdekkeFlate</span><span class="p">,</span>
            <span class="s2">&quot;OBJTYPE = &#39;Havflate&#39; OR OBJTYPE = &#39;Innsjø&#39; OR OBJTYPE = &#39;InnsjøRegulert&#39;&quot;</span><span class="p">,</span>
            <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_input&quot;</span><span class="p">],</span>
        <span class="p">],</span>  <span class="c1"># Water</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
        <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_permanent_feature</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">expression</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">output_name</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data fetched!&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_buffer">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.create_buffer">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_buffer</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating buffers...&quot;</span><span class="p">)</span>
    <span class="n">dam_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_input&quot;</span><span class="p">]</span>
    <span class="n">water_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_input&quot;</span><span class="p">]</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">water_fc</span><span class="p">,</span> <span class="s2">&quot;water_lyr&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByLocation</span><span class="p">(</span>
        <span class="n">in_layer</span><span class="o">=</span><span class="s2">&quot;water_lyr&quot;</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">dam_fc</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;WITHIN_A_DISTANCE&quot;</span><span class="p">,</span>
        <span class="n">search_distance</span><span class="o">=</span><span class="s2">&quot;100 Meters&quot;</span><span class="p">,</span>
        <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">buffers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">dam_fc</span><span class="p">,</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_60m_flat&quot;</span><span class="p">],</span> <span class="s2">&quot;60 Meters&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="n">dam_fc</span><span class="p">,</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_5m&quot;</span><span class="p">],</span> <span class="s2">&quot;5 Meters&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="n">dam_fc</span><span class="p">,</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_60m&quot;</span><span class="p">],</span> <span class="s2">&quot;60 Meters&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;water_lyr&quot;</span><span class="p">,</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_55m&quot;</span><span class="p">],</span> <span class="s2">&quot;55 Meters&quot;</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buffers</span><span class="p">)):</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;FLAT&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&quot;ROUND&quot;</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">out_feature_class</span><span class="o">=</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_buffer&quot;</span><span class="p">,</span>
            <span class="n">buffer_distance_or_field</span><span class="o">=</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">line_end_type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
            <span class="n">dissolve_option</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;PLANAR&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Dissolve</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_buffer&quot;</span><span class="p">,</span>
            <span class="n">out_feature_class</span><span class="o">=</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dissolve_field</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">multi_part</span><span class="o">=</span><span class="s2">&quot;SINGLE_PART&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Buffers created&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_buffer_line">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.create_buffer_line">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_buffer_line</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creates dam buffer as line...&quot;</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_60m&quot;</span><span class="p">]</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;buffer_line&quot;</span><span class="p">]</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">PolygonToLine</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="n">out_feature_class</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dam buffer as line created&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="clip_and_erase_pre">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.clip_and_erase_pre">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clip_and_erase_pre</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hva den gjør:</span>
<span class="sd">        Seperer veier som er innen en mindre buffer rundt demningene og veier som er utenfor, i forbredelse på å flytte veiene.</span>
<span class="sd">        Hvis bru eller sti går over demningen blir det ikke inkludert i veier som skal flyttes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Clipping and erasing roads near dam...&quot;</span><span class="p">)</span>
    <span class="n">dam_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_input&quot;</span><span class="p">]</span>
    <span class="n">roads_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_input&quot;</span><span class="p">]</span>

    <span class="n">buffer_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_35m&quot;</span><span class="p">]</span>
    <span class="n">pre_dissolve</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_inside&quot;</span><span class="p">]</span>
    <span class="n">outside_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_outside&quot;</span><span class="p">]</span>

    <span class="n">water</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_input&quot;</span><span class="p">]</span>
    <span class="n">water_clipped</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_clipped&quot;</span><span class="p">]</span>
    <span class="n">water_center</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_center&quot;</span><span class="p">]</span>
    <span class="n">buffer_water</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;buffer_water&quot;</span><span class="p">]</span>
    <span class="n">water_single</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_singleparts&quot;</span><span class="p">]</span>

    <span class="n">buffer_sti</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_buffer_sti&quot;</span><span class="p">]</span>
    <span class="n">clipped_sti</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_clipped_sti&quot;</span><span class="p">]</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">Buffer_analysis</span><span class="p">(</span>
        <span class="n">dam_fc</span><span class="p">,</span> <span class="n">buffer_fc</span><span class="p">,</span> <span class="s2">&quot;35 Meters&quot;</span><span class="p">,</span> <span class="n">line_end_type</span><span class="o">=</span><span class="s2">&quot;FLAT&quot;</span><span class="p">,</span> <span class="n">dissolve_option</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span>
    <span class="p">)</span>

    <span class="c1"># sletter buffere med bruer slik at de ikke blir flyttet</span>
    <span class="n">fld</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">AddFieldDelimiters</span><span class="p">(</span><span class="n">roads_fc</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">MakeFeatureLayer_management</span><span class="p">(</span>
        <span class="n">roads_fc</span><span class="p">,</span> <span class="s2">&quot;roads_L_lyr&quot;</span><span class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fld</span><span class="si">}</span><span class="s2"> = &#39;L&#39;&quot;</span>
    <span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">MakeFeatureLayer_management</span><span class="p">(</span><span class="n">buffer_fc</span><span class="p">,</span> <span class="s2">&quot;buffer_lyr&quot;</span><span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">SelectLayerByLocation_management</span><span class="p">(</span>
        <span class="n">in_layer</span><span class="o">=</span><span class="s2">&quot;buffer_lyr&quot;</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;INTERSECT&quot;</span><span class="p">,</span> <span class="n">select_features</span><span class="o">=</span><span class="s2">&quot;roads_L_lyr&quot;</span>
    <span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">DeleteFeatures_management</span><span class="p">(</span><span class="s2">&quot;buffer_lyr&quot;</span><span class="p">)</span>

    <span class="c1"># sletter buffere med stier som går rett over demninger slik at de ikke blir flyttet</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Buffer_analysis</span><span class="p">(</span>
        <span class="n">dam_fc</span><span class="p">,</span> <span class="n">buffer_sti</span><span class="p">,</span> <span class="s2">&quot;5 Meters&quot;</span><span class="p">,</span> <span class="n">line_end_type</span><span class="o">=</span><span class="s2">&quot;FLAT&quot;</span><span class="p">,</span> <span class="n">dissolve_option</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span>
    <span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Clip_analysis</span><span class="p">(</span><span class="n">roads_fc</span><span class="p">,</span> <span class="n">buffer_sti</span><span class="p">,</span> <span class="n">clipped_sti</span><span class="p">)</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;objtype&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span><span class="n">clipped_sti</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">objtype</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">length</span>
            <span class="c1"># Keep only features where objtype == &#39;sti&#39; and length &gt; 50</span>
            <span class="k">if</span> <span class="n">objtype</span> <span class="o">!=</span> <span class="s2">&quot;Sti&quot;</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">deleteRow</span><span class="p">()</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">MakeFeatureLayer_management</span><span class="p">(</span><span class="n">buffer_fc</span><span class="p">,</span> <span class="s2">&quot;buffer_lyr_sti&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">MakeFeatureLayer_management</span><span class="p">(</span><span class="n">clipped_sti</span><span class="p">,</span> <span class="s2">&quot;roads_clipped_sti_lyr&quot;</span><span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">SelectLayerByLocation_management</span><span class="p">(</span>
        <span class="s2">&quot;buffer_lyr_sti&quot;</span><span class="p">,</span> <span class="s2">&quot;INTERSECT&quot;</span><span class="p">,</span> <span class="s2">&quot;roads_clipped_sti_lyr&quot;</span>
    <span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">DeleteFeatures_management</span><span class="p">(</span><span class="s2">&quot;buffer_lyr_sti&quot;</span><span class="p">)</span>

    <span class="c1"># Clip and erase veier</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Clip_analysis</span><span class="p">(</span><span class="n">roads_fc</span><span class="p">,</span> <span class="n">buffer_fc</span><span class="p">,</span> <span class="n">pre_dissolve</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Erase_analysis</span><span class="p">(</span><span class="n">roads_fc</span><span class="p">,</span> <span class="n">buffer_fc</span><span class="p">,</span> <span class="n">outside_fc</span><span class="p">)</span>

    <span class="c1"># Lag senterpunkt for vann inni buffer</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Buffer_analysis</span><span class="p">(</span><span class="n">dam_fc</span><span class="p">,</span> <span class="n">buffer_water</span><span class="p">,</span> <span class="s2">&quot;75 Meters&quot;</span><span class="p">,</span> <span class="n">dissolve_option</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Clip_analysis</span><span class="p">(</span><span class="n">water</span><span class="p">,</span> <span class="n">buffer_water</span><span class="p">,</span> <span class="n">water_clipped</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">MultipartToSinglepart_management</span><span class="p">(</span><span class="n">water_clipped</span><span class="p">,</span> <span class="n">water_single</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">FeatureToPoint_management</span><span class="p">(</span><span class="n">water_single</span><span class="p">,</span> <span class="n">water_center</span><span class="p">,</span> <span class="s2">&quot;CENTROID&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="snap_merge_before_moving">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.snap_merge_before_moving">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">snap_merge_before_moving</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hva den gjør:</span>
<span class="sd">        snapper og merger veier som er like før de blir flyttet</span>
<span class="sd">    Hvorfor:</span>
<span class="sd">        gjør det letter å beholde sammenhengen i veiene etter flytting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inside_wdata_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_inside&quot;</span><span class="p">]</span>

    <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">40.0</span>
    <span class="c1"># Precompute squared tolerance for faster distance checks</span>
    <span class="n">tol2</span> <span class="o">=</span> <span class="n">tolerance</span> <span class="o">*</span> <span class="n">tolerance</span>

    <span class="c1"># Helper: squared distance between two arcpy.Points</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_sq_dist</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">p2</span><span class="o">.</span><span class="n">X</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">p2</span><span class="o">.</span><span class="n">Y</span>
        <span class="k">return</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span>

    <span class="c1"># Store seen endpoint‐pairs as a list of tuples: ((x1,y1),(x2,y2))</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Sletter linjer som har nærme endepunkter, for å unngå at det blir dobbelt med linjer etter flytting</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span><span class="n">inside_wdata_fc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="c1"># Extract endpoints</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">get_endpoints_cords</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Skip degenerate geometries</span>
                <span class="k">continue</span>
            <span class="n">p_start</span><span class="p">,</span> <span class="n">p_end</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Check against seen endpoint pairs</span>
            <span class="n">is_duplicate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">),</span> <span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="c1"># Two possible match orders</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">_sq_dist</span><span class="p">(</span><span class="n">p_start</span><span class="p">,</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">_sq_dist</span><span class="p">(</span><span class="n">p_end</span><span class="p">,</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">))</span>
                <span class="n">d3</span> <span class="o">=</span> <span class="n">_sq_dist</span><span class="p">(</span><span class="n">p_start</span><span class="p">,</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">))</span>
                <span class="n">d4</span> <span class="o">=</span> <span class="n">_sq_dist</span><span class="p">(</span><span class="n">p_end</span><span class="p">,</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">d1</span> <span class="o">&lt;=</span> <span class="n">tol2</span> <span class="ow">and</span> <span class="n">d2</span> <span class="o">&lt;=</span> <span class="n">tol2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d3</span> <span class="o">&lt;=</span> <span class="n">tol2</span> <span class="ow">and</span> <span class="n">d4</span> <span class="o">&lt;=</span> <span class="n">tol2</span><span class="p">):</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">deleteRow</span><span class="p">()</span>
                    <span class="n">is_duplicate</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_duplicate</span><span class="p">:</span>
                <span class="c1"># Record this endpoint pair</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">p_start</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">p_start</span><span class="o">.</span><span class="n">Y</span><span class="p">),</span> <span class="p">(</span><span class="n">p_end</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">p_end</span><span class="o">.</span><span class="n">Y</span><span class="p">)))</span>

    <span class="n">backup</span> <span class="o">=</span> <span class="n">build_backup</span><span class="p">(</span><span class="n">inside_wdata_fc</span><span class="p">)</span>
    <span class="n">snap_by_objtype</span><span class="p">(</span><span class="n">inside_wdata_fc</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Snap_edit</span><span class="p">(</span><span class="n">inside_wdata_fc</span><span class="p">,</span> <span class="p">[[</span><span class="n">inside_wdata_fc</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="s2">&quot;40 Meters&quot;</span><span class="p">]])</span>
    <span class="n">restore_deleted_lines</span><span class="p">(</span><span class="n">inside_wdata_fc</span><span class="p">,</span> <span class="n">backup</span><span class="p">)</span>

    <span class="n">merge_all_lines2</span><span class="p">(</span><span class="n">inside_wdata_fc</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span></div>



<div class="viewcode-block" id="edit_geom_pre">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.edit_geom_pre">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">edit_geom_pre</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flytter veier inni buffer litt unna vannet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Moving roads away from water...&quot;</span><span class="p">)</span>
    <span class="n">inside_wdata_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_inside&quot;</span><span class="p">]</span>
    <span class="n">roadlines_moved</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_moved&quot;</span><span class="p">]</span>

    <span class="n">water_center</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_center&quot;</span><span class="p">]</span>

    <span class="n">inside_sr</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Describe</span><span class="p">(</span><span class="n">inside_wdata_fc</span><span class="p">)</span><span class="o">.</span><span class="n">spatialReference</span>
    <span class="n">temp_fc</span> <span class="o">=</span> <span class="n">inside_wdata_fc</span> <span class="o">+</span> <span class="s2">&quot;_temp&quot;</span>

    <span class="c1"># Copy features for editing</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">CopyFeatures</span><span class="p">(</span><span class="n">inside_wdata_fc</span><span class="p">,</span> <span class="n">temp_fc</span><span class="p">)</span>

    <span class="c1"># Create output feature class</span>
    <span class="n">out_path</span><span class="p">,</span> <span class="n">out_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">roadlines_moved</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">CreateFeatureclass_management</span><span class="p">(</span>
        <span class="n">out_path</span><span class="o">=</span><span class="n">out_path</span><span class="p">,</span>
        <span class="n">out_name</span><span class="o">=</span><span class="n">out_name</span><span class="p">,</span>
        <span class="n">geometry_type</span><span class="o">=</span><span class="s2">&quot;POLYLINE&quot;</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="n">temp_fc</span><span class="p">,</span>
        <span class="n">spatial_reference</span><span class="o">=</span><span class="n">inside_sr</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Generate Near Table</span>
    <span class="n">near_table</span> <span class="o">=</span> <span class="s2">&quot;in_memory</span><span class="se">\\</span><span class="s2">near_table&quot;</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">GenerateNearTable</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="n">temp_fc</span><span class="p">,</span>
        <span class="n">near_features</span><span class="o">=</span><span class="n">water_center</span><span class="p">,</span>
        <span class="n">out_table</span><span class="o">=</span><span class="n">near_table</span><span class="p">,</span>
        <span class="n">search_radius</span><span class="o">=</span><span class="s2">&quot;200 Meters&quot;</span><span class="p">,</span>  <span class="c1"># Adjust as needed</span>
        <span class="n">location</span><span class="o">=</span><span class="s2">&quot;LOCATION&quot;</span><span class="p">,</span>
        <span class="n">angle</span><span class="o">=</span><span class="s2">&quot;ANGLE&quot;</span><span class="p">,</span>
        <span class="n">closest</span><span class="o">=</span><span class="s2">&quot;TRUE&quot;</span><span class="p">,</span>
        <span class="n">closest_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Build a lookup of NEAR_X, NEAR_Y for each road feature</span>
    <span class="n">near_lookup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">near_table</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;IN_FID&quot;</span><span class="p">,</span> <span class="s2">&quot;NEAR_X&quot;</span><span class="p">,</span> <span class="s2">&quot;NEAR_Y&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">near_lookup</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">ListFields</span><span class="p">(</span><span class="n">temp_fc</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;OID&quot;</span><span class="p">,</span> <span class="s2">&quot;Geometry&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">temp_fc</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span> <span class="k">as</span> <span class="n">search</span><span class="p">,</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">InsertCursor</span><span class="p">(</span>
        <span class="n">roadlines_moved</span><span class="p">,</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">insert</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
            <span class="n">oid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">shape_length</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">length</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span> <span class="ow">or</span> <span class="n">oid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">near_lookup</span><span class="p">:</span>
                <span class="n">insert</span><span class="o">.</span><span class="n">insertRow</span><span class="p">([</span><span class="n">geom</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">shape_length</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">:</span>
                <span class="c1"># Do not move short lines, just copy them</span>
                <span class="n">insert</span><span class="o">.</span><span class="n">insertRow</span><span class="p">([</span><span class="n">geom</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                <span class="k">continue</span>

            <span class="n">near_x</span><span class="p">,</span> <span class="n">near_y</span> <span class="o">=</span> <span class="n">near_lookup</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span>
            <span class="n">shifted</span> <span class="o">=</span> <span class="n">move_line_away</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">near_x</span><span class="p">,</span> <span class="n">near_y</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
            <span class="n">insert</span><span class="o">.</span><span class="n">insertRow</span><span class="p">([</span><span class="n">shifted</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span></div>



<div class="viewcode-block" id="snap_and_merge_pre">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.snap_and_merge_pre">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">snap_and_merge_pre</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    snapper og kombinerer veier som har blitt flyttet og veier som ikke har blitt flyttet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Snapping and merging roads after moving...&quot;</span><span class="p">)</span>
    <span class="n">dam_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_input&quot;</span><span class="p">]</span>
    <span class="n">roadlines_moved</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_moved&quot;</span><span class="p">]</span>
    <span class="n">outside_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_outside&quot;</span><span class="p">]</span>
    <span class="n">final_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_shifted&quot;</span><span class="p">]</span>

    <span class="n">dam_150m</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_150m&quot;</span><span class="p">]</span>

    <span class="c1"># Define snap environment</span>
    <span class="n">snap_env</span> <span class="o">=</span> <span class="p">[[</span><span class="n">outside_fc</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="s2">&quot;40 Meters&quot;</span><span class="p">]]</span>

    <span class="c1"># Snap</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Snap_edit</span><span class="p">(</span><span class="n">roadlines_moved</span><span class="p">,</span> <span class="n">snap_env</span><span class="p">)</span>

    <span class="n">snap_env2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">roadlines_moved</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="s2">&quot;50 Meters&quot;</span><span class="p">]]</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">Buffer_analysis</span><span class="p">(</span><span class="n">dam_fc</span><span class="p">,</span> <span class="n">dam_150m</span><span class="p">,</span> <span class="s2">&quot;150 Meters&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">MakeFeatureLayer_management</span><span class="p">(</span><span class="n">outside_fc</span><span class="p">,</span> <span class="s2">&quot;outside_lyr&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">SelectLayerByLocation_management</span><span class="p">(</span>
        <span class="n">in_layer</span><span class="o">=</span><span class="s2">&quot;outside_lyr&quot;</span><span class="p">,</span> <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;INTERSECT&quot;</span><span class="p">,</span> <span class="n">select_features</span><span class="o">=</span><span class="n">dam_150m</span>
    <span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">Snap_edit</span><span class="p">(</span><span class="s2">&quot;outside_lyr&quot;</span><span class="p">,</span> <span class="n">snap_env2</span><span class="p">)</span>

    <span class="c1"># Merge the two sets</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">Merge_management</span><span class="p">([</span><span class="n">roadlines_moved</span><span class="p">,</span> <span class="n">outside_fc</span><span class="p">],</span> <span class="n">final_fc</span><span class="p">)</span></div>



<div class="viewcode-block" id="connect_roads_with_buffers">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.connect_roads_with_buffers">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">connect_roads_with_buffers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a dictionary where the keys are al the buffer oids,</span>
<span class="sd">    and the values are lists of lists containing the road geometry and</span>
<span class="sd">    information for all the roads connected to this buffer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[list]: A dictionary with key = buffer_oid, and values are</span>
<span class="sd">            lists of the relevant information (oid, shape, ...) of the</span>
<span class="sd">            related roads</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connects roads with buffers...&quot;</span><span class="p">)</span>

    <span class="n">roads_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;roads_shifted&quot;</span><span class="p">]</span>
    <span class="n">intermediate_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;intermediate&quot;</span><span class="p">]</span>
    <span class="n">buffer_flat_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_60m_flat&quot;</span><span class="p">]</span>
    <span class="n">buffer_round_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_60m&quot;</span><span class="p">]</span>

    <span class="c1"># Starts by changing the relevant roads from potentially multipart to singlepart</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">roads_fc</span><span class="p">,</span> <span class="s2">&quot;roads_lyr_round&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByLocation</span><span class="p">(</span>
        <span class="n">in_layer</span><span class="o">=</span><span class="s2">&quot;roads_lyr_round&quot;</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;WITHIN_A_DISTANCE&quot;</span><span class="p">,</span>
        <span class="n">search_distance</span><span class="o">=</span><span class="s2">&quot;0 Meters&quot;</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">buffer_round_fc</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MultipartToSinglepart</span><span class="p">(</span>
        <span class="s2">&quot;roads_lyr_round&quot;</span><span class="p">,</span> <span class="n">intermediate_fc</span>
    <span class="p">)</span>  <span class="c1"># This creates a new layer</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByLocation</span><span class="p">(</span>  <span class="c1"># Need to add the roads outside the buffer as well</span>
        <span class="n">in_layer</span><span class="o">=</span><span class="s2">&quot;roads_lyr_round&quot;</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;SWITCH_SELECTION&quot;</span>
    <span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;roads_lyr_round&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">intermediate_fc</span><span class="p">,</span> <span class="n">schema_type</span><span class="o">=</span><span class="s2">&quot;NO_TEST&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Finds all roads 60m or closer to a dam</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">intermediate_fc</span><span class="p">,</span> <span class="s2">&quot;roads_lyr_flat&quot;</span><span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">intermediate_fc</span><span class="p">,</span> <span class="s2">&quot;roads_lyr_round_2&quot;</span><span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByLocation</span><span class="p">(</span>
        <span class="n">in_layer</span><span class="o">=</span><span class="s2">&quot;roads_lyr_flat&quot;</span><span class="p">,</span>
        <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;WITHIN_A_DISTANCE&quot;</span><span class="p">,</span>
        <span class="n">search_distance</span><span class="o">=</span><span class="s2">&quot;0 Meters&quot;</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">buffer_flat_fc</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByLocation</span><span class="p">(</span>
        <span class="n">in_layer</span><span class="o">=</span><span class="s2">&quot;roads_lyr_round_2&quot;</span><span class="p">,</span>
        <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
        <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;WITHIN_A_DISTANCE&quot;</span><span class="p">,</span>
        <span class="n">search_distance</span><span class="o">=</span><span class="s2">&quot;0 Meters&quot;</span><span class="p">,</span>
        <span class="n">select_features</span><span class="o">=</span><span class="n">buffer_round_fc</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Collects all the relevant roads</span>
    <span class="n">roads</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span>
        <span class="s2">&quot;roads_lyr_flat&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">,</span> <span class="s2">&quot;objtype&quot;</span><span class="p">,</span> <span class="s2">&quot;vegkategori&quot;</span><span class="p">]</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="c1"># All in the flat buffer</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roads</span><span class="p">:</span>
                <span class="n">roads</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">geom</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">category</span><span class="p">]</span>

    <span class="n">roads</span> <span class="o">=</span> <span class="n">add_road</span><span class="p">(</span>
        <span class="s2">&quot;roads_lyr_round_2&quot;</span><span class="p">,</span> <span class="n">roads</span>
    <span class="p">)</span>  <span class="c1"># Only add the roads in the round buffer that is connected to a road in the flat buffer</span>

    <span class="c1"># Connects roads to buffers (one road can be connected to several buffers)</span>
    <span class="n">buffer_polygons</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">buffer_round_fc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="n">buffer_to_roads</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding nearest buffer for each road...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">roads</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">buffer_poly</span> <span class="ow">in</span> <span class="n">buffer_polygons</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">roads</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">distanceTo</span><span class="p">(</span><span class="n">buffer_poly</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">buffer_to_roads</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">roads</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">roads</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">roads</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
                <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Roads connected to buffers.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">buffer_to_roads</span></div>



<div class="viewcode-block" id="merge_instances">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.merge_instances">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">merge_instances</span><span class="p">(</span><span class="n">roads</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge the selected roads.</span>
<span class="sd">    For each road: select the relevant instances.</span>
<span class="sd">    For each type and category: merge the relevant instances.</span>

<span class="sd">    Args:</span>
<span class="sd">        roads (dict[list]): Dictionary containing all the buffer -&gt; road connections</span>

<span class="sd">    Returns:</span>
<span class="sd">        defaultdict[list]: An updated dictionary with the merged geometry.</span>
<span class="sd">            The list do contain the oid for every connected road</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merge connected instances of same type...&quot;</span><span class="p">)</span>

    <span class="n">intermediate_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;intermediate&quot;</span><span class="p">]</span>

    <span class="n">buffer_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_60m&quot;</span><span class="p">]</span>
    <span class="n">buffer_polygons</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">buffer_fc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="c1"># Global geometry-dictionary</span>
    <span class="n">roads_by_oid</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">oid</span><span class="p">:</span> <span class="p">[</span><span class="n">geom</span><span class="p">,</span> <span class="n">objt</span><span class="p">,</span> <span class="n">category</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">buffer_id</span> <span class="ow">in</span> <span class="n">roads</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">objt</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">roads</span><span class="p">[</span><span class="n">buffer_id</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">roads_to_buffers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">buffer_id</span><span class="p">,</span> <span class="n">road_list</span> <span class="ow">in</span> <span class="n">roads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">road_list</span><span class="p">:</span>
            <span class="n">roads_to_buffers</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">buffer_id</span><span class="p">)</span>

    <span class="n">to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">new_roads</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">intermediate_fc</span><span class="p">,</span> <span class="s2">&quot;roads_lyr&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">buffer_id</span> <span class="ow">in</span> <span class="n">roads</span><span class="p">:</span>
        <span class="n">buffer_geom</span> <span class="o">=</span> <span class="n">buffer_polygons</span><span class="p">[</span><span class="n">buffer_id</span><span class="p">]</span>
        <span class="n">relevant_roads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">oid</span> <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">roads_to_buffers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">buffer_id</span> <span class="ow">in</span> <span class="n">ids</span>
        <span class="p">]</span>
        <span class="n">relevant_roads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">oid</span><span class="p">,</span> <span class="n">roads_by_oid</span><span class="p">[</span><span class="n">oid</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">roads_by_oid</span><span class="p">[</span><span class="n">oid</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">roads_by_oid</span><span class="p">[</span><span class="n">oid</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">relevant_roads</span>
        <span class="p">]</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{</span><span class="n">objtype</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">objtype</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">relevant_roads</span><span class="p">}</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">{</span><span class="n">category</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">relevant_roads</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">relevant_roads</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Checks if there are bridges in the buffer</span>
        <span class="c1"># If so, skip this one</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;OBJECTID IN (</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">oid</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">relevant_roads</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByAttribute</span><span class="p">(</span>
            <span class="n">in_layer_or_view</span><span class="o">=</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span>
            <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
            <span class="n">where_clause</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bridge</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;medium&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">medium</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">medium</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
                    <span class="n">bridge</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">bridge</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                <span class="n">roads_to_edit</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">objt</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">relevant_roads</span>
                    <span class="k">if</span> <span class="n">objt</span> <span class="o">==</span> <span class="n">t</span> <span class="ow">and</span> <span class="n">category</span> <span class="o">==</span> <span class="n">c</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roads_to_edit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;OBJECTID IN (</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">oid</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">roads_to_edit</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

                <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByAttribute</span><span class="p">(</span>
                    <span class="n">in_layer_or_view</span><span class="o">=</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span>
                    <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
                    <span class="n">where_clause</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span>
                    <span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">]</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">update_cursor</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">update_cursor</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">update_cursor</span><span class="o">.</span><span class="n">deleteRow</span><span class="p">()</span>
                            <span class="k">del</span> <span class="n">roads_by_oid</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span>
                            <span class="k">del</span> <span class="n">roads_to_buffers</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span>
                            <span class="k">continue</span>
                        <span class="c1"># Finds candidate to merge</span>
                        <span class="n">merge_oid</span> <span class="o">=</span> <span class="n">find_merge_candidate</span><span class="p">(</span>
                            <span class="n">geom</span><span class="p">,</span>
                            <span class="p">[</span>
                                <span class="n">r</span>
                                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roads_to_edit</span>
                                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">oid</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_delete</span>
                            <span class="p">],</span>
                            <span class="n">buffer_geom</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">merge_oid</span> <span class="ow">is</span> <span class="kc">None</span>
                            <span class="ow">or</span> <span class="n">merge_oid</span> <span class="o">==</span> <span class="n">oid</span>
                            <span class="ow">or</span> <span class="n">merge_oid</span> <span class="ow">in</span> <span class="n">to_delete</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="n">merge_geom</span> <span class="o">=</span> <span class="n">roads_by_oid</span><span class="p">[</span><span class="n">merge_oid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># Combine the two geometries</span>
                        <span class="n">new_geom</span> <span class="o">=</span> <span class="n">merge_lines</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">merge_geom</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_geom</span><span class="p">,</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Geometry</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="n">update_cursor</span><span class="o">.</span><span class="n">updateRow</span><span class="p">((</span><span class="n">oid</span><span class="p">,</span> <span class="n">new_geom</span><span class="p">))</span>
                        <span class="n">roads_by_oid</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_geom</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                        <span class="c1"># Moves the connected buffers of merge_oid to oid</span>
                        <span class="c1"># because this road now does contain these buffers as well</span>
                        <span class="k">if</span> <span class="n">merge_oid</span> <span class="ow">in</span> <span class="n">roads_to_buffers</span><span class="p">:</span>
                            <span class="n">roads_to_buffers</span><span class="p">[</span><span class="n">oid</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">roads_to_buffers</span><span class="p">[</span><span class="n">merge_oid</span><span class="p">])</span>
                        <span class="c1"># Deletes the small duplicate of the road</span>
                        <span class="n">to_delete</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">merge_oid</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">merge_oid</span> <span class="ow">in</span> <span class="n">roads_to_buffers</span><span class="p">:</span>
                            <span class="n">roads_to_buffers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">merge_oid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">merge_oid</span> <span class="ow">in</span> <span class="n">roads_by_oid</span><span class="p">:</span>
                            <span class="n">roads_by_oid</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">merge_oid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;OBJECTID IN (</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">to_delete</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByAttribute</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">delete_cursor</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">delete_cursor</span><span class="p">:</span>
                <span class="n">oid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">delete_cursor</span><span class="o">.</span><span class="n">deleteRow</span><span class="p">()</span>
                <span class="n">roads_by_oid</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">roads_to_buffers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">new_roads</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">buffer_ids</span> <span class="ow">in</span> <span class="n">roads_to_buffers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">buffer_id</span> <span class="ow">in</span> <span class="n">buffer_ids</span><span class="p">:</span>
            <span class="n">new_roads</span><span class="p">[</span><span class="n">buffer_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_roads</span><span class="p">:</span>
        <span class="n">new_roads</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_roads</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Instances merged!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_roads</span></div>



<div class="viewcode-block" id="snap_roads">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.snap_roads">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">snap_roads</span><span class="p">(</span><span class="n">roads</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Snaps roads to the buffer edges.</span>
<span class="sd">    Points that are close to each other are snapped to the same point.</span>

<span class="sd">    Args:</span>
<span class="sd">        roads (dict[list]): Dictionary containing the relationships between buffers and roads</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Snap roads to buffer...&quot;</span><span class="p">)</span>

    <span class="n">intermediate_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;intermediate&quot;</span><span class="p">]</span>
    <span class="n">buffer_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_60m&quot;</span><span class="p">]</span>
    <span class="n">water_buffer_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;water_55m&quot;</span><span class="p">]</span>
    <span class="n">buffer_for_paths</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;dam_5m&quot;</span><span class="p">]</span>

    <span class="n">buffer_polygons</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">buffer_fc</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="c1"># Fetches all the paths going over dam</span>
    <span class="c1"># These should not be snapped</span>
    <span class="n">paths_in_dam</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;paths_in_dam&quot;</span><span class="p">]</span>
    <span class="n">paths_in_dam_valid</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;paths_in_dam_valid&quot;</span><span class="p">]</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span>
        <span class="n">intermediate_fc</span><span class="p">,</span> <span class="s2">&quot;paths_over_dam&quot;</span><span class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="s2">&quot;objtype = &#39;Sti&#39;&quot;</span>
    <span class="p">)</span>
    <span class="n">arcpy</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Intersect</span><span class="p">(</span>
        <span class="n">in_features</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;paths_over_dam&quot;</span><span class="p">,</span> <span class="n">buffer_for_paths</span><span class="p">],</span> <span class="n">out_feature_class</span><span class="o">=</span><span class="n">paths_in_dam</span>
    <span class="p">)</span>

    <span class="n">paths_to_avoid</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">paths_in_dam</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">paths_to_avoid</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths_to_avoid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If some...</span>
        <span class="c1"># ... fetch the entire geometry and oid for these paths</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;OBJECTID IN (</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">paths_to_avoid</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">paths_in_dam</span><span class="p">,</span> <span class="s2">&quot;paths_in_dam_lyr&quot;</span><span class="p">)</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByAttribute</span><span class="p">(</span>
            <span class="s2">&quot;paths_in_dam_lyr&quot;</span><span class="p">,</span> <span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="n">sql</span>
        <span class="p">)</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">CopyFeatures</span><span class="p">(</span><span class="s2">&quot;paths_in_dam_lyr&quot;</span><span class="p">,</span> <span class="n">paths_in_dam_valid</span><span class="p">)</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByLocation</span><span class="p">(</span>
            <span class="s2">&quot;paths_over_dam&quot;</span><span class="p">,</span> <span class="s2">&quot;INTERSECT&quot;</span><span class="p">,</span> <span class="n">paths_in_dam_valid</span>
        <span class="p">)</span>

        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">intermediate_fc</span><span class="p">,</span> <span class="s2">&quot;roads_lyr&quot;</span><span class="p">)</span>

        <span class="n">paths_to_avoid</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">path_geometries</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="s2">&quot;paths_over_dam&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">deleteRow</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">path_geometries</span><span class="p">:</span>
                    <span class="n">paths_to_avoid</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">buf_oid</span><span class="p">,</span> <span class="n">buffer_poly</span> <span class="ow">in</span> <span class="n">buffer_polygons</span><span class="p">:</span>
        <span class="c1"># For all buffer polygons, create the corresponding valid buffer line</span>
        <span class="n">line</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;in_memory\dam_line_final&quot;</span>
        <span class="n">create_single_buffer_line</span><span class="p">(</span><span class="n">buffer_poly</span><span class="p">,</span> <span class="n">water_buffer_fc</span><span class="p">)</span>
        <span class="n">buffer_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;SHAPE@&quot;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buffer_lines</span><span class="p">:</span>
            <span class="c1"># If no line, skip</span>
            <span class="k">continue</span>
        <span class="n">buffer_line</span> <span class="o">=</span> <span class="n">buffer_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Fetch all roads associated with this buffer</span>
        <span class="n">road_list</span> <span class="o">=</span> <span class="n">roads</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">buf_oid</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">road_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If no roads, skip</span>
            <span class="k">continue</span>
        <span class="n">oids</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span> <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">road_list</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;OBJECTID IN (</span><span class="si">{</span><span class="n">oids</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByAttribute</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="s2">&quot;CLEAR_SELECTION&quot;</span><span class="p">)</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByAttribute</span><span class="p">(</span>
            <span class="n">in_layer_or_view</span><span class="o">=</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span>
            <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
            <span class="n">where_clause</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">relevant_roads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">SearchCursor</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">medium</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">paths_to_avoid</span><span class="p">:</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">medium</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="n">relevant_roads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">))</span>
        <span class="c1"># If the road(s) inside the buffer is a bridge, e.i. medium = &quot;L&quot;,</span>
        <span class="c1"># or the buffer contains paths on top of the buffer,</span>
        <span class="c1"># do not snap it</span>
        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Collects points inside the buffer polygon</span>
        <span class="n">points_to_cluster</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">road_oid</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">relevant_roads</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">part_idx</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pt_idx</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Only valid points accepted</span>
                        <span class="k">continue</span>
                    <span class="n">pt_geom</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">PointGeometry</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">buffer_poly</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">pt_geom</span><span class="p">):</span>
                        <span class="c1"># The point is inside the buffer polygon</span>
                        <span class="n">points_to_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">pt_geom</span><span class="p">,</span> <span class="p">(</span><span class="n">road_oid</span><span class="p">,</span> <span class="n">part_idx</span><span class="p">,</span> <span class="n">pt_idx</span><span class="p">))</span>
                        <span class="p">)</span>

        <span class="c1"># Cluster points that are close to each other</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">cluster_points</span><span class="p">(</span><span class="n">points_to_cluster</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Snap points to the buffer line</span>
        <span class="n">snap_points</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="n">ref_pt</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Fetches the first point</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">buffer_line</span><span class="o">.</span><span class="n">queryPointAndDistance</span><span class="p">(</span><span class="n">ref_pt</span><span class="p">)</span>
            <span class="n">snap_pt</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Closest point on buffer line</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="n">_</span><span class="p">,</span>
                <span class="n">idx</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">cluster</span>
            <span class="p">):</span>  <span class="c1"># ... and adjust the rest of the points in the cluster to the ref_pt</span>
                <span class="n">snap_points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">snap_pt</span>

        <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">update_cursor</span><span class="p">:</span>
            <span class="c1"># Update each road</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">update_cursor</span><span class="p">:</span>
                <span class="n">oid</span><span class="p">,</span> <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">new_parts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">part_idx</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
                    <span class="c1"># For each part of the road</span>
                    <span class="n">new_part</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">pt_idx</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">part_idx</span><span class="p">,</span> <span class="n">pt_idx</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">snap_points</span><span class="p">:</span>
                            <span class="c1"># If the point should be snapped, snap it</span>
                            <span class="n">new_pt</span> <span class="o">=</span> <span class="n">snap_points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="n">new_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pt</span><span class="o">.</span><span class="n">firstPoint</span><span class="p">)</span>
                            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
                    <span class="n">new_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arcpy</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">new_part</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="c1"># Update the road geometry if any point was changed</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Polyline</span><span class="p">(</span>
                        <span class="n">arcpy</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">new_parts</span><span class="p">),</span> <span class="n">geom</span><span class="o">.</span><span class="n">spatialReference</span>
                    <span class="p">)</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="n">new_line</span>
                    <span class="n">update_cursor</span><span class="o">.</span><span class="n">updateRow</span><span class="p">((</span><span class="n">oid</span><span class="p">,</span> <span class="n">geom</span><span class="p">))</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Integrate</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="n">cluster_tolerance</span><span class="o">=</span><span class="s2">&quot;5 Meters&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Roads snapped to buffers!&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="remove_sharp_angles">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.remove_sharp_angles">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_sharp_angles</span><span class="p">(</span><span class="n">roads</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects sharp edges in the polylines and deletes these points.</span>

<span class="sd">    Args:</span>
<span class="sd">        roads (dict[list]): Dictionary containing the relationships between buffers and roads</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removes sharp angles...&quot;</span><span class="p">)</span>

    <span class="n">intermediate_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;intermediate&quot;</span><span class="p">]</span>
    <span class="n">cleaned_roads_fc</span> <span class="o">=</span> <span class="n">data_files</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>

    <span class="c1"># Fetch all the road oids</span>
    <span class="n">oids</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">roads</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">oid</span> <span class="ow">in</span> <span class="n">roads</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;OBJECTID IN (</span><span class="si">{</span><span class="n">oids</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">MakeFeatureLayer</span><span class="p">(</span><span class="n">intermediate_fc</span><span class="p">,</span> <span class="s2">&quot;roads_lyr&quot;</span><span class="p">)</span>

        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByAttribute</span><span class="p">(</span>
            <span class="n">in_layer_or_view</span><span class="o">=</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span>
            <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;NEW_SELECTION&quot;</span><span class="p">,</span>
            <span class="n">where_clause</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of roads with deleted points</span>

        <span class="k">with</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">UpdateCursor</span><span class="p">(</span><span class="s2">&quot;roads_lyr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;OID@&quot;</span><span class="p">,</span> <span class="s2">&quot;SHAPE@&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="c1"># Fetch points for each road with valid geometry</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">deleteRow</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">tolerance</span> <span class="o">=</span> <span class="mi">70</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

                <span class="k">while</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
                    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                    <span class="c1"># Calculates the angle between the three points</span>
                    <span class="c1"># With other words: the angle in the centre point</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="n">calculate_angle</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">)</span>
                    <span class="c1"># If the angle is sharper than the tolerance - delete the point</span>
                    <span class="k">if</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">tolerance</span> <span class="ow">or</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">not_road_intersection</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;roads_lyr&quot;</span><span class="p">):</span>
                            <span class="k">del</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Update the geometry based on the points that remains [points]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">new_geom</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Polyline</span><span class="p">(</span><span class="n">arcpy</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">points</span><span class="p">))</span>
                    <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_geom</span>
                    <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">updateRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">CopyFeatures</span><span class="p">(</span><span class="n">intermediate_fc</span><span class="p">,</span> <span class="n">cleaned_roads_fc</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of roads with deleted points: </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sharp angles removed!&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="delete_intermediate_files">
<a class="viewcode-back" href="../../../../generated_docs/generalization.n100.road.html#generalization.n100.road.dam.delete_intermediate_files">[docs]</a>
<span class="nd">@timing_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_intermediate_files</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the intermediate files used during the process</span>
<span class="sd">    of snapping roads away from the dam buffers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files_to_delete</span><span class="p">:</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">data_files</span><span class="p">[</span><span class="n">file</span><span class="p">])</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kartverket.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>