

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>custom_tools.general_tools.partition_iterator &mdash; Automatisk Generalisering 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Automatisk Generalisering
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../generated_docs/custom_tools.html">custom_tools package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated_docs/env_setup.html">env_setup package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated_docs/file_manager.html">file_manager package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated_docs/generalization.n100.building.html">generalization.n100.building package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated_docs/input_data.html">input_data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated_docs/modules.html">automatisk-generalisering</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Automatisk Generalisering</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">custom_tools.general_tools.partition_iterator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for custom_tools.general_tools.partition_iterator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">arcpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">replace</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">is_dataclass</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">composition_configs</span><span class="w"> </span><span class="kn">import</span> <span class="n">core_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">composition_configs</span><span class="w"> </span><span class="kn">import</span> <span class="n">type_defs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">custom_tools.general_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">param_utils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">env_setup</span><span class="w"> </span><span class="kn">import</span> <span class="n">environment_setup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">custom_tools.general_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">custom_arcpy</span><span class="p">,</span> <span class="n">file_utilities</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">custom_tools.decorators.timing_decorator</span><span class="w"> </span><span class="kn">import</span> <span class="n">timing_decorator</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">file_manager.work_file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">PartitionWorkFileManager</span>


<div class="viewcode-block" id="PartitionIterator">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PartitionIterator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Partitioned processing pipeline for large vector datasets with context-aware selection</span>
<span class="sd">    and configurable, injected methods.</span>

<span class="sd">    # Overview</span>
<span class="sd">    This iterator splits work into *cartographic partitions* and processes only the</span>
<span class="sd">    features relevant to each partition. It distinguishes between:</span>
<span class="sd">      - **processing inputs**: primary datasets to process, and</span>
<span class="sd">      - **context inputs**: supporting datasets selected within a configurable distance</span>
<span class="sd">        of the processing features.</span>

<span class="sd">    For each partition, the iterator:</span>
<span class="sd">      1. Selects processing features (center-in partition, plus optional near-by radius).</span>
<span class="sd">      2. Selects context features (within the same radius of the partition).</span>
<span class="sd">      3. Resolves and executes *injected methods* (functions or class methods) whose</span>
<span class="sd">         parameters may include injected I/O paths.</span>
<span class="sd">      4. Appends the partition’s outputs to the configured final outputs.</span>
<span class="sd">      5. Logs iteration catalogs, method parameters, attempts, and errors to a</span>
<span class="sd">         documentation directory.</span>

<span class="sd">    # Catalogs</span>
<span class="sd">    The iterator maintains three dictionaries:</span>
<span class="sd">      - `input_catalog`: per *object* (dataset name) stores metadata and the global input</span>
<span class="sd">        paths; populated from `PartitionIOConfig`.</span>
<span class="sd">      - `output_catalog`: per object stores final output paths; populated from</span>
<span class="sd">        `PartitionIOConfig`.</span>
<span class="sd">      - `iteration_catalog`: per partition, per object, stores iteration-specific paths</span>
<span class="sd">        (e.g., the selected subset path, produced outputs) and counts.</span>

<span class="sd">    The following keys are used inside catalogs:</span>
<span class="sd">      - `INPUT_TYPE_KEY` / `DATA_TYPE_KEY`: metadata about each object’s role and data type.</span>
<span class="sd">      - `INPUT_KEY`: the canonical tag for the active input path of an object.</span>
<span class="sd">      - `COUNT`: number of selected features this iteration.</span>
<span class="sd">      - `DUMMY`: a dummy feature path used to keep downstream logic stable when a</span>
<span class="sd">        particular object has no features in a partition.</span>

<span class="sd">    # Injection &amp; method execution</span>
<span class="sd">    Injected method configs (functions or class methods) may include `InjectIO(object, tag)`</span>
<span class="sd">    placeholders that refer to a *catalog object* (dataset key) and a *tag* (path key).</span>

<span class="sd">    Path resolution rules per partition:</span>
<span class="sd">    - `InjectIO(obj, &quot;input&quot;)`: always resolves to the **selected features for this partition**</span>
<span class="sd">        (never the global dataset), ensuring your method receives only the slice relevant</span>
<span class="sd">        to the current partition.</span>
<span class="sd">    - `InjectIO(obj, some_tag)` where `some_tag != &quot;input&quot;` resolves to a **new, unique</span>
<span class="sd">        iteration-scoped path** under the iteration work directory. If no such entry exists</span>
<span class="sd">        yet for `(obj, some_tag)`, the iterator creates and registers it in the</span>
<span class="sd">        `iteration_catalog[obj][some_tag]`. Your injected method is expected to write to it.</span>
<span class="sd">    - You may introduce **new tags for an existing object** (e.g., `&quot;buffer&quot;`, `&quot;cleaned&quot;`)</span>
<span class="sd">        or even **new objects** via `InjectIO(new_object, new_tag)`. The iterator will allocate</span>
<span class="sd">        paths and track them in `iteration_catalog` as those tags/objects appear in params.</span>

<span class="sd">    Resolution &amp; execution flow:</span>
<span class="sd">    1. `resolve_injected_io_for_methods(...)` deep-walks params (dataclasses, dicts, lists,</span>
<span class="sd">        tuples, sets), replacing every `InjectIO` with a concrete, partition-scoped path, and</span>
<span class="sd">        returns a *resolved* config.</span>
<span class="sd">    2. `execute_injected_methods_with_retry(...)` runs the resolved methods with retry</span>
<span class="sd">        semantics. For class methods, constructor vs method kwargs are split automatically</span>
<span class="sd">        (only names present on `__init__` are sent to the constructor).</span>
<span class="sd">    3. Each attempt produces JSON logs (params, status, exceptions with tracebacks). On</span>
<span class="sd">        success, a consolidated `method_log_{partition_id}.json` is written. On failure,</span>
<span class="sd">        per-attempt logs live under `error_logs/error_{partition_id}/attempt_{n}_error.json`.</span>

<span class="sd">    Notes:</span>
<span class="sd">    - The iterator does **not** implicitly copy data into non-&quot;input&quot; targets; it only</span>
<span class="sd">        allocates file paths. Your injected method is responsible for creating/writing those</span>
<span class="sd">        outputs.</span>
<span class="sd">    - Using `&quot;input&quot;` guarantees you receive the *current partition’s selection*, not the</span>
<span class="sd">        global source.</span>

<span class="sd">    # Partition creation &amp; selection</span>
<span class="sd">    Cartographic partitions are created from all configured processing inputs.</span>
<span class="sd">    For each partition:</span>
<span class="sd">      - Processing features are selected by &quot;center in partition&quot; and optionally augmented</span>
<span class="sd">        with &quot;near partition&quot; features (radius = `context_radius_meters`), with a</span>
<span class="sd">        `PARTITION_FIELD` set to 1 (center-in) or 0 (nearby) to preserve provenance.</span>
<span class="sd">      - Context features are selected by distance to the same partition (using the</span>
<span class="sd">        configured radius).</span>

<span class="sd">    # Logging (documentation directory)</span>
<span class="sd">    At the start of `run()`, the configured `documentation_directory` is cleared and</span>
<span class="sd">    recreated (with safety checks). The iterator writes:</span>
<span class="sd">      - `input_catalog.json`, `output_catalog.json` (initial state),</span>
<span class="sd">      - `iteration_catalog/catalog_{partition_id}.json` (per-partition selection),</span>
<span class="sd">      - `method_logs/method_log_{partition_id}.json` (final success per partition),</span>
<span class="sd">      - `error_logs/error_{partition_id}/attempt_{n}_error.json` (per attempt, on error),</span>
<span class="sd">      - `error_log.json` (retry summary across partitions).</span>

<span class="sd">    # Args (configs)</span>
<span class="sd">    - `partition_io_config (core_config.PartitionIOConfig)`: Declares input objects</span>
<span class="sd">      (processing/context) and output objects (vector outputs) with their paths and</span>
<span class="sd">      data types. Also provides `documentation_directory`.</span>
<span class="sd">    - `partition_method_inject_config (core_config.MethodEntriesConfig)`: The list of</span>
<span class="sd">      injected methods (functions or class methods) with their parameter configs. Any</span>
<span class="sd">      `InjectIO` placeholders will be resolved per partition.</span>
<span class="sd">    - `partition_iterator_run_config (core_config.PartitionRunConfig)`: Runtime knobs:</span>
<span class="sd">      context radius (meters), max elements per partition, partition method</span>
<span class="sd">      (&quot;FEATURES&quot; or &quot;VERTICES&quot;), object ID field, and whether to auto-optimize the</span>
<span class="sd">      partition feature count.</span>
<span class="sd">    - `work_file_manager_config (core_config.WorkFileConfig)`: Controls where and how</span>
<span class="sd">      temporary/iteration/persistent paths are generated.</span>

<span class="sd">    # Side effects</span>
<span class="sd">    - Creates and deletes intermediate feature classes and layers.</span>
<span class="sd">    - Writes JSON logs under `documentation_directory` (safe-guarded).</span>
<span class="sd">    - Appends to final outputs as partitions complete.</span>
<span class="sd">    - Adds then removes (via cleanup) the `PARTITION_FIELD` as needed.</span>

<span class="sd">    # Raises</span>
<span class="sd">    - `ValueError` for duplicate input objects.</span>
<span class="sd">    - `RuntimeError` when no valid partition size can be found (if optimization is enabled).</span>
<span class="sd">    - Any exception thrown inside injected methods is captured, logged, and retried up to</span>
<span class="sd">      the configured maximum. If all retries fail, the exception is re-raised.</span>

<span class="sd">    # Example (high level)</span>
<span class="sd">        iterator = PartitionIterator(</span>
<span class="sd">            partition_io_config=io_config,</span>
<span class="sd">            partition_method_inject_config=methods_config,</span>
<span class="sd">            partition_iterator_run_config=run_config,</span>
<span class="sd">            work_file_manager_config=wm_config,</span>
<span class="sd">        )</span>
<span class="sd">        iterator.run()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">INPUT_TYPE_KEY</span> <span class="o">=</span> <span class="s2">&quot;input_type&quot;</span>
    <span class="n">DATA_TYPE_KEY</span> <span class="o">=</span> <span class="s2">&quot;data_type&quot;</span>
    <span class="n">INPUT_KEY</span> <span class="o">=</span> <span class="s2">&quot;input&quot;</span>
    <span class="n">DUMMY</span> <span class="o">=</span> <span class="s2">&quot;dummy&quot;</span>
    <span class="n">COUNT</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>
    <span class="n">PRE_OPTIMIZATION_COUNT</span> <span class="o">=</span> <span class="s2">&quot;pre_optimization_count&quot;</span>
    <span class="n">REDUCED_COUNT</span> <span class="o">=</span> <span class="s2">&quot;reduced_count&quot;</span>
    <span class="n">PARTITION_FIELD</span> <span class="o">=</span> <span class="s2">&quot;partition_selection_field&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">partition_io_config</span><span class="p">:</span> <span class="n">core_config</span><span class="o">.</span><span class="n">PartitionIOConfig</span><span class="p">,</span>
        <span class="n">partition_method_inject_config</span><span class="p">:</span> <span class="n">core_config</span><span class="o">.</span><span class="n">MethodEntriesConfig</span><span class="p">,</span>
        <span class="n">partition_iterator_run_config</span><span class="p">:</span> <span class="n">core_config</span><span class="o">.</span><span class="n">PartitionRunConfig</span><span class="p">,</span>
        <span class="n">work_file_manager_config</span><span class="p">:</span> <span class="n">core_config</span><span class="o">.</span><span class="n">WorkFileConfig</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            partition_io_config: Declares input objects (processing/context) and output objects</span>
<span class="sd">                (vector outputs) with paths and data types; includes `documentation_directory`.</span>
<span class="sd">            partition_method_inject_config:</span>
<span class="sd">                Declares the injected methods (functions or class methods) with their parameter configs.</span>
<span class="sd">                These configs are expected to include `InjectIO(object, tag)` placeholders that resolve</span>
<span class="sd">                to partition-scoped paths at runtime. Without `InjectIO`, the iterator cannot pass</span>
<span class="sd">                partition selections or allocate iteration outputs, making the class effectively useless.</span>
<span class="sd">                See class docstring section *Injection &amp; method execution* for details.</span>
<span class="sd">            partition_iterator_run_config: Runtime settings (context radius in meters, max</span>
<span class="sd">                elements per partition, partition method &quot;FEATURES&quot;/&quot;VERTICES&quot;, object ID</span>
<span class="sd">                field, whether to optimize partition size).</span>
<span class="sd">            work_file_manager_config: Controls generation of temp/iteration/persistent paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_catalog</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">input_entries_resolved</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">core_config</span><span class="o">.</span><span class="n">ResolvedInputEntry</span><span class="p">(</span>
                <span class="nb">object</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">object</span><span class="p">,</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">input_type</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">input_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">partition_io_config</span><span class="o">.</span><span class="n">input_config</span><span class="o">.</span><span class="n">entries</span>
        <span class="p">]</span>

        <span class="n">output_entries_resolved</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">core_config</span><span class="o">.</span><span class="n">ResolvedOutputEntry</span><span class="p">(</span>
                <span class="nb">object</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">object</span><span class="p">,</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">partition_io_config</span><span class="o">.</span><span class="n">output_config</span><span class="o">.</span><span class="n">entries</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_partition_input_config</span><span class="p">(</span>
            <span class="n">entries</span><span class="o">=</span><span class="n">input_entries_resolved</span><span class="p">,</span>
            <span class="n">target_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_partition_output_config</span><span class="p">(</span>
            <span class="n">entries</span><span class="o">=</span><span class="n">output_entries_resolved</span><span class="p">,</span>
            <span class="n">target_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_catalog</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">documentation_directory</span> <span class="o">=</span> <span class="n">partition_io_config</span><span class="o">.</span><span class="n">documentation_directory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">list_of_methods</span> <span class="o">=</span> <span class="n">partition_method_inject_config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">search_distance</span> <span class="o">=</span> <span class="n">partition_iterator_run_config</span><span class="o">.</span><span class="n">context_radius_meters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_elements_per_partition</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">partition_iterator_run_config</span><span class="o">.</span><span class="n">max_elements_per_partition</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">object_id_field</span> <span class="o">=</span> <span class="n">partition_iterator_run_config</span><span class="o">.</span><span class="n">object_id_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_partition_optimization</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">partition_iterator_run_config</span><span class="o">.</span><span class="n">run_partition_optimization</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;FEATURES&quot;</span><span class="p">,</span> <span class="s2">&quot;VERTICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">partition_iterator_run_config</span><span class="o">.</span><span class="n">partition_method</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_partition_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_partition_feature_count</span><span class="p">:</span> <span class="nb">int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># PartitionIterator currently needs particular configuration for work files, at some steps</span>
        <span class="n">temp_config</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span>
            <span class="n">work_file_manager_config</span><span class="p">,</span> <span class="n">write_to_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_files</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">iteration_config</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span>
            <span class="n">work_file_manager_config</span><span class="p">,</span> <span class="n">write_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep_files</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">persistent_config</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">work_file_manager_config</span><span class="p">,</span> <span class="n">write_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_temp_files</span> <span class="o">=</span> <span class="n">PartitionWorkFileManager</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">temp_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span> <span class="o">=</span> <span class="n">PartitionWorkFileManager</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">iteration_config</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_resolved_files</span> <span class="o">=</span> <span class="n">PartitionWorkFileManager</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">iteration_config</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_persistent_files</span> <span class="o">=</span> <span class="n">PartitionWorkFileManager</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">persistent_config</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_partition_feature</span> <span class="o">=</span> <span class="n">PartitionWorkFileManager</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">iteration_config</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">partition_feature</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_partition_feature</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;partition_feature&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_start_time</span><span class="p">:</span> <span class="nb">float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_times_with_input</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_start_time</span><span class="p">:</span> <span class="nb">float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_injected_log</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="PartitionIterator.resolve_partition_input_config">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.resolve_partition_input_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_partition_input_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">core_config</span><span class="o">.</span><span class="n">ResolvedInputEntry</span><span class="p">],</span>
        <span class="n">target_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add resolved input entries to `target_dict`.</span>

<span class="sd">        Ensures each object appears only once; raises on duplicates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seen_objects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">object</span> <span class="ow">in</span> <span class="n">seen_objects</span> <span class="ow">or</span> <span class="n">entry</span><span class="o">.</span><span class="n">object</span> <span class="ow">in</span> <span class="n">target_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Duplicate input object: &#39;</span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">object</span><span class="si">}</span><span class="s2">&#39; is not supported&quot;</span>
                <span class="p">)</span>
            <span class="n">entry_dict</span> <span class="o">=</span> <span class="n">target_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">entry_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_TYPE_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">input_type</span>
            <span class="n">entry_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_TYPE_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">data_type</span>
            <span class="n">entry_dict</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">path</span>
            <span class="n">seen_objects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">object</span><span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.resolve_partition_output_config">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.resolve_partition_output_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_partition_output_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">core_config</span><span class="o">.</span><span class="n">ResolvedOutputEntry</span><span class="p">],</span>
        <span class="n">target_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add resolved output entries to `target_dict`.</span>

<span class="sd">        Ensures each (object, tag) pair is unique; raises on duplicate tags</span>
<span class="sd">        within the same object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">entry_dict</span> <span class="o">=</span> <span class="n">target_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">entry_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Duplicate output tag &#39;</span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="s2">&#39; detected for object &#39;</span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">object</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
            <span class="n">entry_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_TYPE_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">data_type</span>
            <span class="n">entry_dict</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">path</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_create_cartographic_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates cartographic partitions based on the given element_limit.</span>
<span class="sd">        Overwrites any existing partition feature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_partition_feature</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>
        <span class="n">VALID_TAGS</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">}</span>

        <span class="n">in_features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">path</span>
            <span class="k">for</span> <span class="n">object_</span><span class="p">,</span> <span class="n">tag_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tag_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">VALID_TAGS</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_features</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No input features available for creating partitions.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">arcpy</span><span class="o">.</span><span class="n">cartography</span><span class="o">.</span><span class="n">CreateCartographicPartitions</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="n">in_features</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_feature</span><span class="p">,</span>
            <span class="n">feature_count</span><span class="o">=</span><span class="n">element_limit</span><span class="p">,</span>
            <span class="n">partition_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_method</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created partition feature: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_feature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_count_maximum_objects_in_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        What:</span>
<span class="sd">            Iterates over all partitions and determines the highest number of total processed</span>
<span class="sd">            input features (processing + context) found in any single partition.</span>

<span class="sd">        How:</span>
<span class="sd">            For each partition:</span>
<span class="sd">            - Select the partition geometry.</span>
<span class="sd">            - Run processing and context selection logic.</span>
<span class="sd">            - Track total processed objects.</span>
<span class="sd">            - Cleanup intermediate files.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Maximum number of features found in a partition across all iterations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_max_partition_count</span><span class="p">()</span>
        <span class="n">max_partition_load</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">partition_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_partition_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">iteration_partition</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                    <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;partition_feature_iteration_selection&quot;</span><span class="p">,</span>
                    <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">select_partition_feature</span><span class="p">(</span>
                <span class="n">iteration_partition</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span> <span class="n">object_id</span><span class="o">=</span><span class="n">partition_id</span>
            <span class="p">)</span>

            <span class="n">has_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_all_processing_inputs</span><span class="p">(</span>
                <span class="n">iteration_partition</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
                <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">process_all_context_inputs</span><span class="p">(</span>
                <span class="n">iteration_partition</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
                <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">total_objects</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">max_partition_load</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_partition_load</span><span class="p">,</span> <span class="n">total_objects</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Counting objects for Partition: </span><span class="si">{</span><span class="n">partition_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Current total found: </span><span class="si">{</span><span class="n">total_objects</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Current maximum found: </span><span class="si">{</span><span class="n">max_partition_load</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">max_partition_load</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_partition_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        What:</span>
<span class="sd">            Searches for the optimal `feature_count` that ensures partitioned processing does not exceed</span>
<span class="sd">            the allowed maximum number of features in any single partition.</span>

<span class="sd">        How:</span>
<span class="sd">            Starts at the configured feature_count and decreases in steps until a valid configuration is found.</span>
<span class="sd">            Validity is determined by calling _count_maximum_objects_in_partition.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: A valid feature_count value that respects object limits.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If no valid feature_count is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_elements_per_partition</span><span class="p">)</span>
        <span class="n">max_allowed</span> <span class="o">=</span> <span class="n">candidate</span>
        <span class="n">previous_partitions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_decrement</span><span class="p">(</span><span class="n">current</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_allowed</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">current</span> <span class="o">-</span> <span class="n">max_allowed</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Attempt </span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s2">: Testing candidate feature_count = </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_cartographic_partitions</span><span class="p">(</span><span class="n">element_limit</span><span class="o">=</span><span class="n">candidate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_max_partition_count</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_partition_count</span> <span class="o">==</span> <span class="n">previous_partitions</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_allowed</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stable partition count. Reducing candidate to </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">previous_partitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_partition_count</span>
            <span class="n">max_objects_found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_maximum_objects_in_partition</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; -&gt; Max objects found in a partition: </span><span class="si">{</span><span class="n">max_objects_found</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_objects_found</span> <span class="o">&lt;=</span> <span class="n">max_allowed</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected feature_count: </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_partition_feature_count</span> <span class="o">=</span> <span class="n">candidate</span>
                <span class="k">return</span> <span class="n">candidate</span>

            <span class="n">decrement</span> <span class="o">=</span> <span class="n">_calculate_decrement</span><span class="p">(</span><span class="n">max_objects_found</span><span class="p">)</span>
            <span class="n">candidate</span> <span class="o">-=</span> <span class="n">decrement</span>

            <span class="k">if</span> <span class="n">candidate</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No valid feature count found under limit=</span><span class="si">{</span><span class="n">max_allowed</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Minimum candidate tested: </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="PartitionIterator.delete_final_outputs">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.delete_final_outputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_final_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes all final output feature classes if they exist.&quot;&quot;&quot;</span>
        <span class="n">skip_keys</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_TYPE_KEY</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">final_output_path</span> <span class="ow">in</span> <span class="n">tag_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">skip_keys</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">file_utilities</span><span class="o">.</span><span class="n">delete_feature</span><span class="p">(</span><span class="n">input_feature</span><span class="o">=</span><span class="n">final_output_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.delete_iteration_files">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.delete_iteration_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_iteration_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">file_paths</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes multiple feature classes or files from a list.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
            <span class="n">file_utilities</span><span class="o">.</span><span class="n">delete_feature</span><span class="p">(</span><span class="n">input_feature</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.create_dummy_features">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.create_dummy_features">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_dummy_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create dummy feature classes for all objects that have a valid path</span>
<span class="sd">        under the given tag. Used to provide stable placeholder inputs when</span>
<span class="sd">        a partition produces no features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">tag_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">template_path</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">dummy_feature_path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_persistent_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                    <span class="n">object_name</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                    <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;dummy_feature&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">file_utilities</span><span class="o">.</span><span class="n">create_feature_class</span><span class="p">(</span>
                <span class="n">template_feature</span><span class="o">=</span><span class="n">template_path</span><span class="p">,</span> <span class="n">new_feature</span><span class="o">=</span><span class="n">dummy_feature_path</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">DUMMY</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy_feature_path</span></div>


<div class="viewcode-block" id="PartitionIterator.update_empty_object_tag_with_dummy_file">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.update_empty_object_tag_with_dummy_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_empty_object_tag_with_dummy_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">object_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replaces the value for the given tag with the dummy path if available for the object_key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">dummy_path</span> <span class="o">=</span> <span class="n">tag_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DUMMY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dummy_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tag_dict</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy_path</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_documentation_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure documentation_directory is ready for this run.</span>
<span class="sd">        Deletes the whole directory if it exists, then recreates it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docu_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">documentation_directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docu_dir</span><span class="p">,</span> <span class="n">type_defs</span><span class="o">.</span><span class="n">SubdirectoryPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;documentation_directory must be SubdirectoryPath, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">docu_dir</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">docu_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">docu_dir</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">docu_dir_path</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">docu_dir_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Refusing to delete root directory: </span><span class="si">{</span><span class="n">docu_dir_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">docu_dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">docu_dir_path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">docu_dir_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="PartitionIterator.write_documentation">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.write_documentation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_documentation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dict_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a JSON file to documentation_directory or its subdirectory.</span>
<span class="sd">        Ensures the destination directory exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">documentation_directory</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">sub_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">sub_dir</span> <span class="k">else</span> <span class="n">base_dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
        <span class="n">file_utilities</span><span class="o">.</span><span class="n">write_dict_to_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">json_path</span><span class="p">,</span> <span class="n">dict_data</span><span class="o">=</span><span class="n">dict_data</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_jsonify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make params JSON-safe:</span>
<span class="sd">        - dataclasses -&gt; asdict</span>
<span class="sd">        - Path -&gt; str</span>
<span class="sd">        - sets -&gt; lists</span>
<span class="sd">        - dict/list/tuple -&gt; recurse</span>
<span class="sd">        - otherwise return as-is</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">t</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">obj</span>

<div class="viewcode-block" id="PartitionIterator.update_max_partition_count">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.update_max_partition_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_max_partition_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the maximum OBJECTID for partitioning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_partition_count</span> <span class="o">=</span> <span class="n">file_utilities</span><span class="o">.</span><span class="n">count_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_feature</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_vector_of_type</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tag_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">input_type</span><span class="p">:</span> <span class="n">core_config</span><span class="o">.</span><span class="n">InputType</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True iff `tag_dict` represents a vector dataset of the given `input_type`</span>
<span class="sd">        (PROCESSING or CONTEXT) and has an active `INPUT_KEY` path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">tag_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_TYPE_KEY</span><span class="p">)</span> <span class="o">==</span> <span class="n">input_type</span><span class="o">.</span><span class="n">value</span>
            <span class="ow">and</span> <span class="n">tag_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_TYPE_KEY</span><span class="p">)</span> <span class="o">==</span> <span class="n">core_config</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">VECTOR</span><span class="o">.</span><span class="n">value</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span> <span class="ow">in</span> <span class="n">tag_dict</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_processing_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yield (object_key, input_path) for all PROCESSING vector inputs present in `input_catalog`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_vector_of_type</span><span class="p">(</span>
                <span class="n">tag_dict</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">input_type</span><span class="o">=</span><span class="n">core_config</span><span class="o">.</span><span class="n">InputType</span><span class="o">.</span><span class="n">PROCESSING</span>
            <span class="p">):</span>
                <span class="k">yield</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_context_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yield (object_key, input_path) for all CONTEXT vector inputs present in `input_catalog`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_vector_of_type</span><span class="p">(</span>
                <span class="n">tag_dict</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">input_type</span><span class="o">=</span><span class="n">core_config</span><span class="o">.</span><span class="n">InputType</span><span class="o">.</span><span class="n">CONTEXT</span>
            <span class="p">):</span>
                <span class="k">yield</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_output_vector_items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Yield (object_key, tag, final_output_path) for vector outputs only.</span>
<span class="sd">        Mirrors _processing_items/_context_items for consistency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tag_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_TYPE_KEY</span><span class="p">)</span> <span class="o">!=</span> <span class="n">core_config</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">VECTOR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">final_output_path</span> <span class="ow">in</span> <span class="n">tag_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DATA_TYPE_KEY</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">yield</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">final_output_path</span>

<div class="viewcode-block" id="PartitionIterator.prepare_input_data">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.prepare_input_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare all inputs for partitioning.</span>

<span class="sd">        - Processing inputs: counted and tagged with a `PARTITION_FIELD`.</span>
<span class="sd">        - Context inputs: either counted directly (if search_distance &lt;= 0)</span>
<span class="sd">        or filtered to features within the search radius of processing inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">input_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing_items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_processing_input</span><span class="p">(</span><span class="n">object_key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">input_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">input_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_context_input</span><span class="p">(</span><span class="n">object_key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span> <span class="n">input_path</span><span class="o">=</span><span class="n">input_path</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_processing_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a processing input for partitioning.</span>

<span class="sd">        - Registers the input path and feature count in `input_catalog`.</span>
<span class="sd">        - Deletes `PARTITION_FIELD` if it exists, then creates the field.</span>
<span class="sd">        - This helper field is required during partitioning and will later</span>
<span class="sd">        be removed by `cleanup_partition_fields` to restore clean inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_utilities</span><span class="o">.</span><span class="n">count_objects</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="o">=</span><span class="n">input_path</span>
        <span class="p">)</span>

        <span class="n">existing_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">ListFields</span><span class="p">(</span><span class="n">input_path</span><span class="p">)}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARTITION_FIELD</span> <span class="ow">in</span> <span class="n">existing_fields</span><span class="p">:</span>
            <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">DeleteField</span><span class="p">(</span>
                <span class="n">in_table</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span>
                <span class="n">drop_field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PARTITION_FIELD</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">AddField_management</span><span class="p">(</span>
            <span class="n">in_table</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span>
            <span class="n">field_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PARTITION_FIELD</span><span class="p">,</span>
            <span class="n">field_type</span><span class="o">=</span><span class="s2">&quot;LONG&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_context_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a context input for partitioning.</span>

<span class="sd">        - If `search_distance &lt;= 0`: registers the raw input and its feature count.</span>
<span class="sd">        - Otherwise:</span>
<span class="sd">            * Creates a filtered copy of the input,</span>
<span class="sd">            * Selects features within `search_distance` of each processing input,</span>
<span class="sd">            * Appends them into the filtered dataset,</span>
<span class="sd">            * Registers the filtered dataset and its feature count in `input_catalog`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">PRE_OPTIMIZATION_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">file_utilities</span><span class="o">.</span><span class="n">count_objects</span><span class="p">(</span><span class="n">input_layer</span><span class="o">=</span><span class="n">input_path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_distance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_utilities</span><span class="o">.</span><span class="n">count_objects</span><span class="p">(</span>
                <span class="n">input_layer</span><span class="o">=</span><span class="n">input_path</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">processing_input_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processing_items</span><span class="p">())</span>

        <span class="n">filtered_context_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_persistent_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                <span class="n">object_name</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;input_contex_filtered&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">file_utilities</span><span class="o">.</span><span class="n">create_feature_class</span><span class="p">(</span>
            <span class="n">template_feature</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span> <span class="n">new_feature</span><span class="o">=</span><span class="n">filtered_context_path</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">processing_object</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">processing_input_objects</span><span class="p">:</span>
            <span class="n">memory_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_temp_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                <span class="n">object_name</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;near_</span><span class="si">{</span><span class="n">processing_object</span><span class="si">}</span><span class="s2">_selection&quot;</span>
            <span class="p">)</span>
            <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_location_and_make_feature_layer</span><span class="p">(</span>
                <span class="n">input_layer</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span>
                <span class="n">overlap_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">OverlapType</span><span class="o">.</span><span class="n">WITHIN_A_DISTANCE</span><span class="p">,</span>
                <span class="n">select_features</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                <span class="n">output_name</span><span class="o">=</span><span class="n">memory_layer</span><span class="p">,</span>
                <span class="n">search_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_distance</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="n">memory_layer</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">filtered_context_path</span><span class="p">,</span>
                <span class="n">schema_type</span><span class="o">=</span><span class="s2">&quot;NO_TEST&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_temp_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_context_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_utilities</span><span class="o">.</span><span class="n">count_objects</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="o">=</span><span class="n">filtered_context_path</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">REDUCED_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">PRE_OPTIMIZATION_COUNT</span><span class="p">]</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">[</span><span class="n">object_key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">]</span>
        <span class="p">)</span>

<div class="viewcode-block" id="PartitionIterator.select_partition_feature">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.select_partition_feature">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_partition_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_partition</span><span class="p">,</span> <span class="n">object_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selects partition feature based on OBJECTID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_permanent_feature</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">partition_feature</span><span class="p">,</span>
            <span class="n">expression</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">object_id_field</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">output_name</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.process_single_processing_input">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.process_single_processing_input">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_single_processing_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">object_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">iteration_partition</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select and prepare a single processing input for one partition.</span>

<span class="sd">        How:</span>
<span class="sd">        - Selects features whose center lies within the partition.</span>
<span class="sd">        - Marks them with `PARTITION_FIELD = 1` and copies to an iteration-scoped dataset.</span>
<span class="sd">        - If `search_distance &gt; 0`, also selects nearby features:</span>
<span class="sd">            * Includes features within the search radius but not center-in,</span>
<span class="sd">            * Marks them with `PARTITION_FIELD = 0`,</span>
<span class="sd">            * Appends them to the same iteration dataset.</span>
<span class="sd">        - Updates `iteration_catalog` with path and feature count.</span>
<span class="sd">        - Creates a dummy feature if no features are found.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the partition contains any features for this object,</span>
<span class="sd">            False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iteration_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">object_key</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">selection_memory_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_temp_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                <span class="n">object_name</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;centerpoint_in_partition&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_location_and_make_feature_layer</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span>
            <span class="n">overlap_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">OverlapType</span><span class="o">.</span><span class="n">HAVE_THEIR_CENTER_IN</span><span class="p">,</span>
            <span class="n">select_features</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
            <span class="n">output_name</span><span class="o">=</span><span class="n">selection_memory_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">center_count</span> <span class="o">=</span> <span class="n">file_utilities</span><span class="o">.</span><span class="n">count_objects</span><span class="p">(</span><span class="n">selection_memory_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">center_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">iteration_entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_empty_object_tag_with_dummy_file</span><span class="p">(</span>
                <span class="n">object_key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">arcpy</span><span class="o">.</span><span class="n">CalculateField_management</span><span class="p">(</span>
            <span class="n">in_table</span><span class="o">=</span><span class="n">selection_memory_path</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PARTITION_FIELD</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
        <span class="p">)</span>

        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
            <span class="n">object_name</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
            <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;iteration_selection&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">file_utilities</span><span class="o">.</span><span class="n">create_feature_class</span><span class="p">(</span>
            <span class="n">template_feature</span><span class="o">=</span><span class="n">selection_memory_path</span><span class="p">,</span> <span class="n">new_feature</span><span class="o">=</span><span class="n">output_path</span>
        <span class="p">)</span>
        <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">selection_memory_path</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
            <span class="n">schema_type</span><span class="o">=</span><span class="s2">&quot;NO_TEST&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nearby_selection</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_temp_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                    <span class="n">object_name</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                    <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                    <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;near_partiton_selection&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_location_and_make_feature_layer</span><span class="p">(</span>
                <span class="n">input_layer</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span>
                <span class="n">overlap_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">OverlapType</span><span class="o">.</span><span class="n">WITHIN_A_DISTANCE</span><span class="p">,</span>
                <span class="n">select_features</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
                <span class="n">output_name</span><span class="o">=</span><span class="n">nearby_selection</span><span class="p">,</span>
                <span class="n">selection_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">SelectionType</span><span class="o">.</span><span class="n">NEW_SELECTION</span><span class="p">,</span>
                <span class="n">search_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_distance</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">SelectLayerByLocation</span><span class="p">(</span>
                <span class="n">in_layer</span><span class="o">=</span><span class="n">nearby_selection</span><span class="p">,</span>
                <span class="n">overlap_type</span><span class="o">=</span><span class="s2">&quot;HAVE_THEIR_CENTER_IN&quot;</span><span class="p">,</span>
                <span class="n">select_features</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
                <span class="n">selection_type</span><span class="o">=</span><span class="s2">&quot;REMOVE_FROM_SELECTION&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">arcpy</span><span class="o">.</span><span class="n">CalculateField_management</span><span class="p">(</span>
                <span class="n">in_table</span><span class="o">=</span><span class="n">nearby_selection</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PARTITION_FIELD</span><span class="p">,</span>
                <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="n">nearby_selection</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
                <span class="n">schema_type</span><span class="o">=</span><span class="s2">&quot;NO_TEST&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">iteration_entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">file_utilities</span><span class="o">.</span><span class="n">count_objects</span><span class="p">(</span><span class="n">input_layer</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_distance</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="n">center_count</span>
        <span class="p">)</span>
        <span class="n">iteration_entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_temp_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="PartitionIterator.process_all_processing_inputs">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.process_all_processing_inputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_all_processing_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iteration_partition</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">has_inputs</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process all configured processing inputs for one partition.</span>
<span class="sd">    </span>
<span class="sd">        - Calls `process_single_processing_input` for each processing object.</span>
<span class="sd">        - Aggregates results to track whether any inputs produced features.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if at least one processing input had features,</span>
<span class="sd">            False if all were empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">input_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing_items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_single_processing_input</span><span class="p">(</span>
                <span class="n">object_key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                <span class="n">input_path</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span>
                <span class="n">iteration_partition</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
                <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">has_inputs</span> <span class="o">=</span> <span class="n">has_inputs</span> <span class="ow">or</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">has_inputs</span></div>


<div class="viewcode-block" id="PartitionIterator.process_single_context_input">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.process_single_context_input">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_single_context_input</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">object_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">iteration_partition</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select and prepare a single context input for one partition.</span>

<span class="sd">        How:</span>
<span class="sd">        - Selects features within `search_distance` of the partition geometry.</span>
<span class="sd">        - Writes the selection to an iteration-scoped dataset.</span>
<span class="sd">        - Updates `iteration_catalog` with feature count and path.</span>
<span class="sd">        - If no features are found, assigns a dummy feature path.</span>

<span class="sd">        Side effects:</span>
<span class="sd">            Creates/deletes temporary feature classes and updates `iteration_catalog`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iteration_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">object_key</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
            <span class="n">object_name</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
            <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;iteration_selection&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_location_and_make_permanent_feature</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span>
            <span class="n">overlap_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">OverlapType</span><span class="o">.</span><span class="n">WITHIN_A_DISTANCE</span><span class="p">,</span>
            <span class="n">select_features</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
            <span class="n">output_name</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
            <span class="n">selection_type</span><span class="o">=</span><span class="n">custom_arcpy</span><span class="o">.</span><span class="n">SelectionType</span><span class="o">.</span><span class="n">NEW_SELECTION</span><span class="p">,</span>
            <span class="n">search_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">search_distance</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="n">file_utilities</span><span class="o">.</span><span class="n">count_objects</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">iteration_entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_path</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_empty_object_tag_with_dummy_file</span><span class="p">(</span>
                <span class="n">object_key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span>
            <span class="p">)</span>
        <span class="n">iteration_entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span></div>


<div class="viewcode-block" id="PartitionIterator.process_all_context_inputs">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.process_all_context_inputs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_all_context_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iteration_partition</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process all configured context inputs for one partition.</span>

<span class="sd">        Calls `process_single_context_input` for each context object</span>
<span class="sd">        and records results in `iteration_catalog`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">input_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_single_context_input</span><span class="p">(</span>
                <span class="n">object_key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                <span class="n">input_path</span><span class="o">=</span><span class="n">input_path</span><span class="p">,</span>
                <span class="n">iteration_partition</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
                <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.track_iteration_time">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.track_iteration_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">track_iteration_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">inputs_present</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tracks runtime and estimates remaining time based on iterations with inputs.</span>
<span class="sd">        Prints current time, elapsed runtime, and estimated remaining runtime.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iteration_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_start_time</span>
        <span class="k">if</span> <span class="n">inputs_present</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration_times_with_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iteration_time</span><span class="p">)</span>

        <span class="n">avg_runtime</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration_times_with_input</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration_times_with_input</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_times_with_input</span>
            <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">total_runtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_start_time</span>
        <span class="n">remaining_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_partition_count</span> <span class="o">-</span> <span class="n">object_id</span>
        <span class="n">estimate_remaining</span> <span class="o">=</span> <span class="n">remaining_iterations</span> <span class="o">*</span> <span class="n">avg_runtime</span>

        <span class="n">now_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">total_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">total_runtime</span><span class="p">)))</span>
        <span class="n">estimate_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">estimate_remaining</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="n">now_str</span><span class="si">}</span><span class="s2">] &quot;</span> <span class="sa">f</span><span class="s2">&quot;Runtime: </span><span class="si">{</span><span class="n">total_str</span><span class="si">}</span><span class="s2"> | &quot;</span> <span class="sa">f</span><span class="s2">&quot;Remaining: </span><span class="si">{</span><span class="n">estimate_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.resolve_injected_io_for_methods">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.resolve_injected_io_for_methods">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_injected_io_for_methods</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method_entries_config</span><span class="p">:</span> <span class="n">core_config</span><span class="o">.</span><span class="n">MethodEntriesConfig</span><span class="p">,</span>
        <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">core_config</span><span class="o">.</span><span class="n">MethodEntriesConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inject concrete paths into each method entry by resolving InjectIO objects.</span>
<span class="sd">        Returns a new MethodEntriesConfig with fully resolved params.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolved_configs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">method_entries_config</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">core_config</span><span class="o">.</span><span class="n">FuncMethodEntryConfig</span><span class="p">):</span>
                <span class="n">resolved_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_param_injections</span><span class="p">(</span>
                    <span class="n">method_config</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">params</span><span class="p">),</span>
                    <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">resolved_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">core_config</span><span class="o">.</span><span class="n">FuncMethodEntryConfig</span><span class="p">(</span>
                        <span class="n">func</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">resolved_params</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">core_config</span><span class="o">.</span><span class="n">ClassMethodEntryConfig</span><span class="p">):</span>
                <span class="n">resolved_init</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resolve_param_injections</span><span class="p">(</span>
                        <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">init_params</span><span class="p">),</span> <span class="n">partition_id</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">init_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="n">resolved_method</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resolve_param_injections</span><span class="p">(</span>
                        <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">method_params</span><span class="p">),</span> <span class="n">partition_id</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">method_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="n">resolved_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">core_config</span><span class="o">.</span><span class="n">ClassMethodEntryConfig</span><span class="p">(</span>
                        <span class="n">class_</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                        <span class="n">init_params</span><span class="o">=</span><span class="n">resolved_init</span><span class="p">,</span>
                        <span class="n">method_params</span><span class="o">=</span><span class="n">resolved_method</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported method entry type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">core_config</span><span class="o">.</span><span class="n">MethodEntriesConfig</span><span class="p">(</span><span class="n">entries</span><span class="o">=</span><span class="n">resolved_configs</span><span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.resolve_param_injections">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.resolve_param_injections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_param_injections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively resolve InjectIO instances in any nested structure.</span>
<span class="sd">        Supports dicts, lists, tuples, and sets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_config</span><span class="p">,</span> <span class="n">core_config</span><span class="o">.</span><span class="n">InjectIO</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_inject_entry</span><span class="p">(</span>
                <span class="n">inject</span><span class="o">=</span><span class="n">method_config</span><span class="p">,</span> <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">method_config</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_config</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">resolved_values</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_param_injections</span><span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">method_config</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">partition_id</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="n">method_config</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="n">method_config</span><span class="p">,</span> <span class="o">**</span><span class="n">resolved_values</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_param_injections</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">method_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_config</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_param_injections</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">method_config</span>
            <span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_config</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_param_injections</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">method_config</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_config</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_param_injections</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">method_config</span>
            <span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">method_config</span></div>


<div class="viewcode-block" id="PartitionIterator.resolve_inject_entry">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.resolve_inject_entry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_inject_entry</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inject</span><span class="p">:</span> <span class="n">core_config</span><span class="o">.</span><span class="n">InjectIO</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve a single `InjectIO` placeholder to a concrete path for this partition.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inject</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span> <span class="ow">and</span> <span class="n">inject</span><span class="o">.</span><span class="n">object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="p">[</span><span class="n">inject</span><span class="o">.</span><span class="n">object</span><span class="p">][</span><span class="n">inject</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_resolved_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
            <span class="n">object_name</span><span class="o">=</span><span class="n">inject</span><span class="o">.</span><span class="n">object</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">inject</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
            <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">inject</span><span class="o">.</span><span class="n">object</span><span class="p">,</span> <span class="p">{})[</span><span class="n">inject</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">return</span> <span class="n">path</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_format_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON-safe dict with exception type, message, and full formatted traceback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">))),</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
            <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">format</span><span class="p">()),</span>
        <span class="p">}</span>

<div class="viewcode-block" id="PartitionIterator.execute_injected_methods">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.execute_injected_methods">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_injected_methods</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method_entries_config</span><span class="p">:</span> <span class="n">core_config</span><span class="o">.</span><span class="n">MethodEntriesConfig</span><span class="p">,</span>
        <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a fully *resolved* set of injected methods for one partition/attempt.</span>

<span class="sd">        For each entry:</span>
<span class="sd">        - If it&#39;s a class method: split kwargs into constructor vs. method args,</span>
<span class="sd">            instantiate the class, then call the method.</span>
<span class="sd">        - If it&#39;s a function: call it with the provided kwargs.</span>

<span class="sd">        Logging:</span>
<span class="sd">        - Builds an in-memory `execution_log` with:</span>
<span class="sd">            - per-entry raw params (JSON-safe), split class/method params (for classes),</span>
<span class="sd">            - status (&quot;ok&quot; or &quot;error&quot;), and full exception info (type/message/traceback) on error.</span>
<span class="sd">        - On any exception, stores the partial log in `self._last_injected_log` and re-raises;</span>
<span class="sd">            the retry layer is responsible for persisting per-attempt error logs.</span>

<span class="sd">        Args:</span>
<span class="sd">            method_entries_config: The *resolved* (no remaining InjectIO) method entries.</span>
<span class="sd">            partition_id: Current partition identifier (for log context).</span>
<span class="sd">            attempt: 1-based attempt number (for log context).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: The complete per-attempt execution log when all entries succeed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Re-raises the first failure after recording it in `self._last_injected_log`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">execution_log</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;partition_id&quot;</span><span class="p">:</span> <span class="n">partition_id</span><span class="p">,</span>
            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;execute&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attempt&quot;</span><span class="p">:</span> <span class="n">attempt</span><span class="p">,</span>
            <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">method_entries_config</span><span class="o">.</span><span class="n">entries</span><span class="p">):</span>
            <span class="n">record</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">core_config</span><span class="o">.</span><span class="n">ClassMethodEntryConfig</span><span class="p">):</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">class_</span>

                    <span class="c1"># Resolve method (string or callable)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">method_callable</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
                        <span class="n">method_name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">method</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">method_callable</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">method</span>
                        <span class="n">method_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">method_callable</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">method_callable</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># Enforce positional dataclass-only for ctor + method</span>
                    <span class="n">ctor_args</span> <span class="o">=</span> <span class="n">param_utils</span><span class="o">.</span><span class="n">ensure_dataclass_list</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">init_params</span><span class="p">)</span>
                    <span class="n">call_args</span> <span class="o">=</span> <span class="n">param_utils</span><span class="o">.</span><span class="n">ensure_dataclass_list</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">method_params</span><span class="p">)</span>

                    <span class="n">param_utils</span><span class="o">.</span><span class="n">validate_positional_arity</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctor_args</span><span class="p">))</span>
                    <span class="n">param_utils</span><span class="o">.</span><span class="n">validate_positional_arity</span><span class="p">(</span>
                        <span class="n">method_callable</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">call_args</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="n">record</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method_name</span><span class="p">,</span>
                            <span class="s2">&quot;init_params&quot;</span><span class="p">:</span> <span class="n">param_utils</span><span class="o">.</span><span class="n">payload_log</span><span class="p">(</span>
                                <span class="n">entry</span><span class="o">.</span><span class="n">init_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;method_params&quot;</span><span class="p">:</span> <span class="n">param_utils</span><span class="o">.</span><span class="n">payload_log</span><span class="p">(</span>
                                <span class="n">entry</span><span class="o">.</span><span class="n">method_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;init_positional&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctor_args</span><span class="p">),</span>
                            <span class="s2">&quot;call_positional&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">call_args</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">ctor_args</span><span class="p">)</span>
                    <span class="n">method_callable</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="o">*</span><span class="n">call_args</span><span class="p">)</span>

                    <span class="n">record</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span>
                    <span class="n">execution_log</span><span class="p">[</span><span class="s2">&quot;entries&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">core_config</span><span class="o">.</span><span class="n">FuncMethodEntryConfig</span><span class="p">):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">func</span>
                    <span class="n">func_args</span> <span class="o">=</span> <span class="n">param_utils</span><span class="o">.</span><span class="n">ensure_dataclass_list</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                    <span class="n">param_utils</span><span class="o">.</span><span class="n">validate_positional_arity</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_args</span><span class="p">))</span>

                    <span class="n">record</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                            <span class="s2">&quot;func_params&quot;</span><span class="p">:</span> <span class="n">param_utils</span><span class="o">.</span><span class="n">payload_log</span><span class="p">(</span>
                                <span class="n">entry</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;func_positional&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_args</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                    <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">func_args</span><span class="p">)</span>

                    <span class="n">record</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span>
                    <span class="n">execution_log</span><span class="p">[</span><span class="s2">&quot;entries&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported method entry type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">record</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
                <span class="n">record</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">record</span><span class="p">[</span><span class="s2">&quot;exception&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">execution_log</span><span class="p">[</span><span class="s2">&quot;entries&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_injected_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">execution_log</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_injected_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">execution_log</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">execution_log</span></div>


<div class="viewcode-block" id="PartitionIterator.execute_injected_methods_with_retry">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.execute_injected_methods_with_retry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_injected_methods_with_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute injected methods for a partition with retries and structured logging.</span>

<span class="sd">        Flow per attempt:</span>
<span class="sd">        1) Reset `self._last_injected_log` to ensure clean state.</span>
<span class="sd">        2) Resolve InjectIO placeholders to concrete, partition-scoped paths.</span>
<span class="sd">            - If resolution fails, write an error attempt log with stage=&quot;resolve&quot;.</span>
<span class="sd">        3) Run `execute_injected_methods(...)`.</span>
<span class="sd">            - On success: write `method_logs/method_log_{partition_id}.json` and return.</span>
<span class="sd">            - On failure: write `error_logs/error_{partition_id}/attempt_{n}_error.json`,</span>
<span class="sd">            increment `self.error_log[partition_id]`, and retry until max_retries.</span>

<span class="sd">        Args:</span>
<span class="sd">            partition_id: Current partition identifier.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Re-raises the last error after exhausting retries; also writes</span>
<span class="sd">            `error_log.json` and the final per-attempt error snapshot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">50</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_injected_log</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_resolved_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>

                <span class="n">resolved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_injected_io_for_methods</span><span class="p">(</span>
                    <span class="n">method_entries_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_of_methods</span><span class="p">,</span>
                    <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">execution_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_injected_methods</span><span class="p">(</span>
                    <span class="n">method_entries_config</span><span class="o">=</span><span class="n">resolved</span><span class="p">,</span>
                    <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                    <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_documentation</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;method_log_</span><span class="si">{</span><span class="n">partition_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">dict_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">execution_log</span><span class="p">),</span>
                    <span class="n">sub_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;method_logs&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">attempt_log</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_injected_log&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt_log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attempt_log</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;partition_id&quot;</span><span class="p">:</span> <span class="n">partition_id</span><span class="p">,</span>
                        <span class="s2">&quot;attempt&quot;</span><span class="p">:</span> <span class="n">attempt</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;resolve&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;exception&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_exception</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_documentation</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;attempt_</span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">_error&quot;</span><span class="p">,</span>
                    <span class="n">dict_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_jsonify</span><span class="p">(</span><span class="n">attempt_log</span><span class="p">),</span>
                    <span class="n">sub_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;error_logs&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;error_</span><span class="si">{</span><span class="n">partition_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2"> failed with error: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">partition_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">[</span><span class="n">partition_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;Number of retries&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;Error Messages&quot;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="p">}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">[</span><span class="n">partition_id</span><span class="p">][</span><span class="s2">&quot;Number of retries&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">[</span><span class="n">partition_id</span><span class="p">][</span><span class="s2">&quot;Error Messages&quot;</span><span class="p">][</span><span class="n">attempt</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_message</span>

                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max retries reached.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_documentation</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;error_log&quot;</span><span class="p">,</span> <span class="n">dict_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">)</span>

                    <span class="k">raise</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_append_partition_selected_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">object_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">iteration_path</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">final_output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether the intermediate result for the given object and tag is valid,</span>
<span class="sd">        and appends it to the final output if so.</span>

<span class="sd">        Args:</span>
<span class="sd">            object_key (str): The object identifier (e.g. &#39;building_polygons&#39;).</span>
<span class="sd">            tag (str): The processing tag (e.g. &#39;some_logic&#39;).</span>
<span class="sd">            final_output_path (str): Destination output path.</span>
<span class="sd">            partition_id (int): Current partition identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_utilities</span><span class="o">.</span><span class="n">feature_has_rows</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">iteration_path</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">partition_selection_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_temp_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                <span class="n">object_name</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;partition_final_output_append_selection&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">custom_arcpy</span><span class="o">.</span><span class="n">select_attribute_and_make_feature_layer</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="o">=</span><span class="n">iteration_path</span><span class="p">,</span>
            <span class="n">expression</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">PARTITION_FIELD</span><span class="si">}</span><span class="s2"> = 1&quot;</span><span class="p">,</span>
            <span class="n">output_name</span><span class="o">=</span><span class="n">partition_selection_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_utilities</span><span class="o">.</span><span class="n">feature_has_rows</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">partition_selection_path</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">final_output_path</span><span class="p">):</span>
                <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">CopyFeatures</span><span class="p">(</span>
                    <span class="n">in_features</span><span class="o">=</span><span class="n">partition_selection_path</span><span class="p">,</span>
                    <span class="n">out_feature_class</span><span class="o">=</span><span class="n">final_output_path</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created final output for </span><span class="si">{</span><span class="n">object_key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span>
                    <span class="n">inputs</span><span class="o">=</span><span class="n">partition_selection_path</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">final_output_path</span><span class="p">,</span>
                    <span class="n">schema_type</span><span class="o">=</span><span class="s2">&quot;NO_TEST&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appended to final output for </span><span class="si">{</span><span class="n">object_key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_temp_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>

<div class="viewcode-block" id="PartitionIterator.append_iteration_outputs_to_final">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.append_iteration_outputs_to_final">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append_iteration_outputs_to_final</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends all valid outputs for the current iteration to their final output paths.</span>

<span class="sd">        Skips any objects marked as dummy and ensures only non-empty, valid inputs are appended.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">final_output_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_vector_items</span><span class="p">():</span>
            <span class="n">iteration_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">iteration_entry</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">iteration_paths</span> <span class="o">=</span> <span class="n">iteration_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_partition_selected_features</span><span class="p">(</span>
                <span class="n">object_key</span><span class="o">=</span><span class="n">object_key</span><span class="p">,</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span>
                <span class="n">iteration_path</span><span class="o">=</span><span class="n">iteration_paths</span><span class="p">,</span>
                <span class="n">final_output_path</span><span class="o">=</span><span class="n">final_output_path</span><span class="p">,</span>
                <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.cleanup_helper_fields">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.cleanup_helper_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_helper_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the helper field `PARTITION_FIELD` from:</span>
<span class="sd">        - All final output feature classes.</span>
<span class="sd">        - All processing input feature classes (since it was injected for partitioning).</span>

<span class="sd">        Ensures that only clean data structures remain after the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">PARTITION_FIELD</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">tag_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">final_output_path</span> <span class="ow">in</span> <span class="n">tag_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaning fields in: </span><span class="si">{</span><span class="n">final_output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">file_utilities</span><span class="o">.</span><span class="n">delete_fields_if_exist</span><span class="p">(</span>
                    <span class="n">final_output_path</span><span class="p">,</span> <span class="n">fields_to_delete</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">object_key</span><span class="p">,</span> <span class="n">input_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processing_items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaning fields in processing input: </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">file_utilities</span><span class="o">.</span><span class="n">delete_fields_if_exist</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">fields_to_delete</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_iteration_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing Partition: </span><span class="si">{</span><span class="n">partition_id</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_partition_count</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="PartitionIterator.partition_iteration">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.partition_iteration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">partition_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process every cartographic partition end-to-end.</span>

<span class="sd">        Workflow (per partition):</span>
<span class="sd">        1) Reset iteration state and select the partition geometry.</span>
<span class="sd">        2) Select processing inputs (center-in; optionally add near-by features).</span>
<span class="sd">            - If no processing features are present, skip this partition.</span>
<span class="sd">        3) Select context inputs within the configured search radius.</span>
<span class="sd">        4) Execute injected methods with retry and structured logging.</span>
<span class="sd">        5) Persist the iteration catalog and append valid outputs to final outputs.</span>

<span class="sd">        Raises:</span>
<span class="sd">        - Propagates any unhandled exception from injected methods after retries are exhausted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_max_partition_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">partition_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_partition_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_iteration_state</span><span class="p">(</span><span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">)</span>

            <span class="n">iteration_partition</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span><span class="o">.</span><span class="n">generate_partition_path</span><span class="p">(</span>
                    <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;partition_feature_iteration_selection&quot;</span><span class="p">,</span>
                    <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select_partition_feature</span><span class="p">(</span>
                <span class="n">iteration_partition</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span> <span class="n">object_id</span><span class="o">=</span><span class="n">partition_id</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">inputs_present_in_partition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_all_processing_inputs</span><span class="p">(</span>
                    <span class="n">iteration_partition</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span>
                    <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs_present_in_partition</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">process_all_context_inputs</span><span class="p">(</span>
                    <span class="n">iteration_partition</span><span class="o">=</span><span class="n">iteration_partition</span><span class="p">,</span> <span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">execute_injected_methods_with_retry</span><span class="p">(</span><span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_documentation</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;catalog_</span><span class="si">{</span><span class="n">partition_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">dict_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration_catalog</span><span class="p">,</span>
                    <span class="n">sub_dir</span><span class="o">=</span><span class="s2">&quot;iteration_catalog&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_iteration_outputs_to_final</span><span class="p">(</span><span class="n">partition_id</span><span class="o">=</span><span class="n">partition_id</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_iteration_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_resolved_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">track_iteration_time</span><span class="p">(</span><span class="n">partition_id</span><span class="p">,</span> <span class="n">inputs_present_in_partition</span><span class="p">)</span></div>


<div class="viewcode-block" id="PartitionIterator.run">
<a class="viewcode-back" href="../../../generated_docs/custom_tools.general_tools.html#custom_tools.general_tools.partition_iterator.PartitionIterator.run">[docs]</a>
    <span class="nd">@timing_decorator</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orchestrate the full pipeline: preparation → partitioning → iteration → cleanup.</span>

<span class="sd">        Steps:</span>
<span class="sd">        1) Reset the documentation directory (with safety checks) and write `output_catalog.json`.</span>
<span class="sd">        2) Data preparation:</span>
<span class="sd">            - Optionally delete existing final outputs.</span>
<span class="sd">            - Prepare processing and context inputs (add PARTITION_FIELD, pre-filter context).</span>
<span class="sd">            - Create per-object dummy features.</span>
<span class="sd">            - Write `input_catalog.json`.</span>
<span class="sd">        3) Partitioning:</span>
<span class="sd">            - Determine feature count (optimize if enabled) and create cartographic partitions.</span>
<span class="sd">        4) Iteration:</span>
<span class="sd">            - Call `partition_iteration()` to process all partitions, execute injected methods,</span>
<span class="sd">            and append per-partition results to final outputs.</span>
<span class="sd">        5) Cleanup &amp; logs:</span>
<span class="sd">            - Remove helper fields from final outputs (e.g., PARTITION_FIELD).</span>
<span class="sd">            - Delete persistent temp files.</span>
<span class="sd">            - Write aggregated `error_log.json`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_documentation_dir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_documentation</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;output_catalog&quot;</span><span class="p">,</span> <span class="n">dict_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_catalog</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting Data Preparation...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_final_outputs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_input_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_dummy_features</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">INPUT_KEY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_documentation</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_catalog&quot;</span><span class="p">,</span> <span class="n">dict_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_catalog</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Creating Cartographic Partitions...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_partition_feature_count</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_find_partition_size</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_partition_optimization</span>
            <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_elements_per_partition</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_cartographic_partitions</span><span class="p">(</span>
            <span class="n">element_limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">final_partition_feature_count</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting on Partition Iteration...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partition_iteration</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_helper_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_file_manager_persistent_files</span><span class="o">.</span><span class="n">delete_created_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_documentation</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;error_log&quot;</span><span class="p">,</span> <span class="n">dict_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">)</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">environment_setup</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kartverket.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>